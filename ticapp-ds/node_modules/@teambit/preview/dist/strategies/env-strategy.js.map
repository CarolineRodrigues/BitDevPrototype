{"version":3,"sources":["env-strategy.ts"],"names":["EnvBundlingStrategy","constructor","preview","computeTargets","context","previewDefs","outputPath","getOutputPath","htmlConfig","generateHtmlConfig","dev","entries","computePaths","html","components","options","config","title","templateContent","cache","minify","computeResults","results","result","componentsResults","map","component","errors","err","message","warning","warnings","startTime","endTime","artifacts","getArtifactDef","env","rootDir","getDirName","name","globPatterns","envName","id","replace","capsuleNetwork","capsulesRootDir","getPaths","files","capsule","compiler","getCompiler","file","path","getDistPathBySrcPath","relative","defs","previewMain","writePreviewRuntime","moduleMapsPromise","previewDef","moduleMap","getModuleMap","paths","ComponentMap","as","graphCapsules","getCapsule","maybeFiles","get","compiledPaths","template","renderTemplatePath","link","writeLink","prefix","undefined","toArray","concat","moduleMaps","Promise","all"],"mappings":"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","sourcesContent":["import { join, resolve } from 'path';\nimport { existsSync, mkdirpSync } from 'fs-extra';\nimport { flatten } from 'lodash';\nimport { ComponentMap } from '@teambit/component';\nimport { Compiler } from '@teambit/compiler';\nimport { AbstractVinyl } from '@teambit/legacy/dist/consumer/component/sources';\nimport { Capsule } from '@teambit/isolator';\nimport { ComponentResult } from '@teambit/builder';\nimport { BundlerContext, BundlerHtmlConfig, BundlerResult } from '@teambit/bundler';\nimport type { BundlingStrategy, ComputeTargetsContext } from '../bundling-strategy';\nimport { PreviewDefinition } from '../preview-definition';\nimport { PreviewMain } from '../preview.main.runtime';\nimport { html } from '../webpack';\n\n/**\n * bundles all components in a given env into the same bundle.\n */\nexport class EnvBundlingStrategy implements BundlingStrategy {\n  name = 'env';\n\n  constructor(private preview: PreviewMain) {}\n\n  async computeTargets(context: ComputeTargetsContext, previewDefs: PreviewDefinition[]) {\n    const outputPath = this.getOutputPath(context);\n    if (!existsSync(outputPath)) mkdirpSync(outputPath);\n    const htmlConfig = this.generateHtmlConfig({ dev: context.dev });\n\n    return [\n      {\n        entries: await this.computePaths(outputPath, previewDefs, context),\n        html: [htmlConfig],\n        components: context.components,\n        outputPath,\n      },\n    ];\n  }\n\n  private generateHtmlConfig(options: { dev?: boolean }): BundlerHtmlConfig {\n    const config = {\n      title: 'Preview',\n      templateContent: html('Preview'),\n      cache: false,\n      minify: options?.dev ?? true,\n    };\n    return config;\n  }\n\n  async computeResults(context: BundlerContext, results: BundlerResult[]) {\n    const result = results[0];\n\n    const componentsResults: ComponentResult[] = result.components.map((component) => {\n      return {\n        component,\n        errors: result.errors.map((err) => (typeof err === 'string' ? err : err.message)),\n        warning: result.warnings,\n        startTime: result.startTime,\n        endTime: result.endTime,\n      };\n    });\n\n    const artifacts = this.getArtifactDef(context);\n\n    return {\n      componentsResults,\n      artifacts,\n    };\n  }\n\n  private getArtifactDef(context: ComputeTargetsContext) {\n    // eslint-disable-next-line @typescript-eslint/prefer-as-const\n    const env: 'env' = 'env';\n    const rootDir = this.getDirName(context);\n\n    return [\n      {\n        name: 'preview',\n        globPatterns: ['public/**'],\n        rootDir,\n        context: env,\n      },\n    ];\n  }\n\n  getDirName(context: ComputeTargetsContext) {\n    const envName = context.id.replace('/', '__');\n    return `${envName}-preview`;\n  }\n\n  private getOutputPath(context: ComputeTargetsContext) {\n    return resolve(`${context.capsuleNetwork.capsulesRootDir}/${this.getDirName(context)}`);\n  }\n\n  private getPaths(context: ComputeTargetsContext, files: AbstractVinyl[], capsule: Capsule) {\n    const compiler: Compiler = context.env.getCompiler();\n    return files.map((file) => join(capsule.path, compiler.getDistPathBySrcPath(file.relative)));\n  }\n\n  private async computePaths(\n    outputPath: string,\n    defs: PreviewDefinition[],\n    context: ComputeTargetsContext\n  ): Promise<string[]> {\n    const previewMain = await this.preview.writePreviewRuntime(context);\n    const moduleMapsPromise = defs.map(async (previewDef) => {\n      const moduleMap = await previewDef.getModuleMap(context.components);\n\n      const paths = ComponentMap.as(context.components, (component) => {\n        const capsule = context.capsuleNetwork.graphCapsules.getCapsule(component.id);\n        const maybeFiles = moduleMap.get(component);\n        if (!maybeFiles || !capsule) return [];\n        const [, files] = maybeFiles;\n        const compiledPaths = this.getPaths(context, files, capsule);\n        return compiledPaths;\n      });\n\n      const template = previewDef.renderTemplatePath ? await previewDef.renderTemplatePath(context) : 'undefined';\n\n      const link = this.preview.writeLink(\n        previewDef.prefix,\n        paths,\n        previewDef.renderTemplatePath ? await previewDef.renderTemplatePath(context) : undefined,\n        outputPath,\n        false\n      );\n\n      const files = flatten(paths.toArray().map(([, file]) => file)).concat([link]);\n\n      if (template) return files.concat([template]);\n      return files;\n    });\n\n    const moduleMaps = await Promise.all(moduleMapsPromise);\n\n    return flatten(moduleMaps.concat([previewMain]));\n  }\n}\n"]}