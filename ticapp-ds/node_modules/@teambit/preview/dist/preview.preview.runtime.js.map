{"version":3,"sources":["preview.preview.runtime.tsx"],"names":["PREVIEW_MODULES","PreviewPreview","constructor","pubsub","previewSlot","renderingContextSlot","rootExt","previewName","componentId","getLocation","name","getDefault","isDev","preview","getPreview","PreviewNotFound","includesAll","Promise","all","include","map","prevName","includedPreview","undefined","selectPreviewModel","fullName","getPreviewModule","includes","filter","module","componentAspects","getComponentAspects","toString","render","getRenderingContext","fetchComponentAspects","max","maxAge","registerClickPubSub","window","addEventListener","e","timestamp","Date","now","clickEvent","Object","assign","pub","PreviewAspect","id","ClickInsideAnIframeEvent","parentPreviewName","relevantModel","componentMap","component","fetchComponentPreview","mainModule","previewFile","allFiles","fetchComponentPreviewFiles","resolve","forEach","file","endsWith","addComponentFileElement","reject","previewScriptElement","getPreviewScriptElement","document","head","appendChild","previewBundleFileName","addComponentFileScriptElement","addComponentFileLinkElement","previewAssetsRoute","stringId","url","res","status","parsed","json","isBundledWithEnv","files","length","script","createElement","setAttribute","previewRoute","src","link","href","onload","componentPreview","toStringWithoutVersion","targetPreview","registerPreview","register","aspectsFilter","RenderingContext","registerRenderContext","renderContext","previews","values","defaultOne","find","previewCandidate","default","getParam","query","param","params","URLSearchParams","get","withoutHash","location","hash","substring","before","after","split","ComponentID","tryFromString","provider","config","PreviewRuntime","PubsubAspect","Slot","withType","linkModules","previewModule","addRuntime"],"mappings":"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","sourcesContent":["import PubsubAspect, { PubsubPreview } from '@teambit/pubsub';\nimport { Slot, SlotRegistry } from '@teambit/harmony';\nimport { ComponentID } from '@teambit/component-id';\nimport crossFetch from 'cross-fetch';\nimport memoize from 'memoizee';\n\nimport { PreviewNotFound } from './exceptions';\nimport { PreviewType } from './preview-type';\nimport { PreviewAspect, PreviewRuntime } from './preview.aspect';\nimport { ClickInsideAnIframeEvent } from './events';\nimport { PreviewModule } from './types/preview-module';\nimport { RenderingContext } from './rendering-context';\nimport { fetchComponentAspects } from './gql/fetch-component-aspects';\n\nexport type PreviewSlot = SlotRegistry<PreviewType>;\n\nconst PREVIEW_MODULES: Record<string, PreviewModule> = {};\n\nexport type RenderingContextOptions = { aspectsFilter?: string[] };\nexport type RenderingContextProvider = (options: RenderingContextOptions) => { [key: string]: any };\nexport type RenderingContextSlot = SlotRegistry<RenderingContextProvider>;\n\nexport class PreviewPreview {\n  constructor(\n    /**\n     * register to pubsub\n     */\n    private pubsub: PubsubPreview,\n\n    /**\n     * preview slot.\n     */\n    private previewSlot: PreviewSlot,\n\n    private renderingContextSlot: RenderingContextSlot\n  ) {\n    this.registerClickPubSub();\n  }\n\n  private registerClickPubSub() {\n    window.addEventListener('click', (e) => {\n      const timestamp = Date.now();\n      const clickEvent = Object.assign({}, e);\n      this.pubsub.pub(PreviewAspect.id, new ClickInsideAnIframeEvent(timestamp, clickEvent));\n    });\n  }\n\n  private isDev = false;\n\n  /**\n   * render the preview.\n   */\n  render = async (rootExt?: string) => {\n    const { previewName, componentId } = this.getLocation();\n    const name = previewName || this.getDefault();\n    if (rootExt) this.isDev = rootExt === 'teambit.workspace/workspace';\n\n    const preview = this.getPreview(name);\n    if (!preview || !componentId) {\n      throw new PreviewNotFound(previewName);\n    }\n\n    const includesAll = await Promise.all(\n      (preview.include || []).map(async (prevName) => {\n        const includedPreview = this.getPreview(prevName);\n        if (!includedPreview) return undefined;\n\n        return includedPreview.selectPreviewModel?.(\n          componentId.fullName,\n          await this.getPreviewModule(prevName, componentId, name)\n        );\n      })\n    );\n\n    const includes = includesAll.filter((module) => !!module);\n    // during build / tag, the component is isolated, so all aspects are relevant, and do not require filtering\n    const componentAspects = this.isDev ? await this.getComponentAspects(componentId.toString()) : undefined;\n\n    return preview.render(\n      componentId,\n      await this.getPreviewModule(name, componentId),\n      includes,\n      this.getRenderingContext(componentAspects)\n    );\n  };\n\n  async getPreviewModule(name: string, id: ComponentID, parentPreviewName?: string): Promise<PreviewModule> {\n    const relevantModel = PREVIEW_MODULES[name];\n    if (relevantModel.componentMap[id.fullName]) return relevantModel;\n\n    let component;\n    // Handle case when there is overview but no composition on the workspace dev server\n    if (!parentPreviewName || !PREVIEW_MODULES[parentPreviewName].componentMap[id.fullName]) {\n      // if (!window[name]) throw new PreviewNotFound(name);\n      // const isSplitComponentBundle = relevantModel.isSplitComponentBundle ?? false;\n      // const component = window[id.toStringWithoutVersion()];\n      component = await this.fetchComponentPreview(id, name);\n    }\n\n    return {\n      mainModule: relevantModel.mainModule,\n      componentMap: {\n        [id.fullName]: component,\n      },\n    };\n  }\n\n  async fetchComponentPreview(id: ComponentID, name: string) {\n    let previewFile;\n    const allFiles = await this.fetchComponentPreviewFiles(id, name);\n    // It's a component bundled with the env\n    if (allFiles === null) {\n      return Promise.resolve(undefined);\n    }\n    allFiles.forEach((file) => {\n      // We want to run the preview file always last\n      if (file.endsWith('-preview.js')) {\n        previewFile = file;\n      } else {\n        this.addComponentFileElement(id, file);\n      }\n    });\n    return new Promise((resolve, reject) => {\n      const previewScriptElement = this.getPreviewScriptElement(id, name, previewFile, resolve, reject);\n      document.head.appendChild(previewScriptElement);\n    });\n  }\n\n  private addComponentFileElement(id: ComponentID, previewBundleFileName: string) {\n    if (previewBundleFileName.endsWith('.js')) {\n      return this.addComponentFileScriptElement(id, previewBundleFileName);\n    }\n    return this.addComponentFileLinkElement(id, previewBundleFileName);\n  }\n\n  private async fetchComponentPreviewFiles(id: ComponentID, previewName: string): Promise<string[] | null> {\n    const previewAssetsRoute = `~aspect/preview-assets`;\n    const stringId = id.toString();\n    const url = `/api/${stringId}/${previewAssetsRoute}`;\n\n    const res = await crossFetch(url);\n    if (res.status >= 400) {\n      throw new PreviewNotFound(previewName);\n    }\n    const parsed = await res.json();\n    // This is component bundled with the env, no reason to bring the files, as they will be the files of the env\n    if (parsed.isBundledWithEnv) {\n      return null;\n    }\n    if (!parsed.files || !parsed.files.length) {\n      throw new PreviewNotFound(previewName);\n    }\n    return parsed.files;\n  }\n\n  private addComponentFileScriptElement(id: ComponentID, previewBundleFileName: string) {\n    const script = document.createElement('script');\n    script.setAttribute('defer', 'defer');\n    const stringId = id.toString();\n    const previewRoute = `~aspect/component-preview`;\n    const src = `/api/${stringId}/${previewRoute}/${previewBundleFileName}`;\n    script.src = src;\n    document.head.appendChild(script);\n    return script;\n  }\n\n  private addComponentFileLinkElement(id: ComponentID, previewBundleFileName: string) {\n    const link = document.createElement('link');\n    const stringId = id.toString();\n    const previewRoute = `~aspect/component-preview`;\n    const href = `/api/${stringId}/${previewRoute}/${previewBundleFileName}`;\n    link.setAttribute('href', href);\n    if (previewBundleFileName.endsWith('.css')) {\n      link.setAttribute('rel', 'stylesheet');\n    }\n    document.head.appendChild(link);\n    return link;\n  }\n\n  private getPreviewScriptElement(id: ComponentID, name: string, previewBundleFileName: string, resolve, reject) {\n    const script = document.createElement('script');\n    script.setAttribute('defer', 'defer');\n    const stringId = id.toString();\n    // const previewRoute = `~aspect/preview`;\n    const previewRoute = `~aspect/component-preview`;\n    const src = `/api/${stringId}/${previewRoute}/${previewBundleFileName}`;\n    script.src = src; // generate path to remote scope. [scope url]/\n    script.onload = () => {\n      const componentPreview = window[`${id.toStringWithoutVersion()}-preview`];\n      if (!componentPreview) return reject(new PreviewNotFound(name));\n      const targetPreview = componentPreview[name];\n      if (!targetPreview) return resolve(undefined);\n\n      return resolve(targetPreview);\n    };\n    return script;\n  }\n\n  private getComponentAspects = memoize(fetchComponentAspects, {\n    max: 100,\n    maxAge: 12 * 60 * 60 * 1000,\n  });\n\n  /**\n   * register a new preview.\n   */\n  registerPreview(preview: PreviewType) {\n    this.previewSlot.register(preview);\n    return this;\n  }\n\n  /**\n   * get the preview rendering context.\n   */\n  getRenderingContext(aspectsFilter?: string[]) {\n    return new RenderingContext(this.renderingContextSlot, { aspectsFilter });\n  }\n\n  /**\n   * allows aspects to add rendering contexts.\n   * render context is available through all preview definitions.\n   */\n  registerRenderContext(renderContext: RenderingContextProvider) {\n    this.renderingContextSlot.register(renderContext);\n    return this;\n  }\n\n  getDefault() {\n    const previews = this.previewSlot.values();\n    const defaultOne = previews.find((previewCandidate) => previewCandidate.default);\n\n    return defaultOne?.name || previews[0].name;\n  }\n\n  private getPreview(previewName: string): undefined | PreviewType {\n    const previews = this.previewSlot.values();\n    const preview = previews.find((previewCandidate) => previewCandidate.name === previewName);\n\n    return preview;\n  }\n\n  private getParam(query: string, param: string) {\n    const params = new URLSearchParams(query);\n    return params.get(param);\n  }\n\n  private getLocation() {\n    const withoutHash = window.location.hash.substring(1);\n    const [before, after] = withoutHash.split('?');\n\n    return {\n      previewName: this.getParam(after, 'preview'),\n      componentId: ComponentID.tryFromString(before),\n    };\n  }\n\n  static runtime = PreviewRuntime;\n\n  static dependencies = [PubsubAspect];\n\n  static slots = [Slot.withType<PreviewType>(), Slot.withType<RenderingContextProvider>()];\n\n  static async provider(\n    [pubsub]: [PubsubPreview],\n    config,\n    [previewSlot, renderingContextSlot]: [PreviewSlot, RenderingContextSlot]\n  ) {\n    const preview = new PreviewPreview(pubsub, previewSlot, renderingContextSlot);\n\n    window.addEventListener('hashchange', () => {\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      preview.render();\n    });\n\n    return preview;\n  }\n}\n\nexport function linkModules(previewName: string, previewModule: PreviewModule) {\n  PREVIEW_MODULES[previewName] = previewModule;\n}\n\nPreviewAspect.addRuntime(PreviewPreview);\n"]}