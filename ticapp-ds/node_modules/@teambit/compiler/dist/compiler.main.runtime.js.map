{"version":3,"sources":["compiler.main.runtime.ts"],"names":["CompilerMain","constructor","pubsub","workspaceCompiler","envs","builder","compileOnWorkspace","componentsIds","options","initiator","CompilationInitiator","ComponentAdded","compileComponents","createTask","name","compiler","CompilerTask","CompilerAspect","id","getDistPathBySrcPath","component","srcPath","environment","getEnv","env","compilerInstance","getCompiler","getDistsFiles","artifacts","getArtifactsVinylByExtension","length","DistArtifactNotFound","DistArtifact","provider","cli","workspace","loggerMain","aspectLoader","ui","generator","logger","createLogger","WorkspaceCompiler","registerService","CompilerService","compilerMain","register","CompileCmd","registerComponentTemplate","compilerTemplate","ManyComponentsWriter","externalCompiler","bind","MainRuntime","CLIAspect","WorkspaceAspect","EnvsAspect","LoggerAspect","PubsubAspect","AspectLoaderAspect","BuilderAspect","UIAspect","GeneratorAspect","addRuntime"],"mappings":"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","sourcesContent":["import AspectLoaderAspect, { AspectLoaderMain } from '@teambit/aspect-loader';\nimport { BuilderAspect, BuilderMain } from '@teambit/builder';\nimport { CLIAspect, CLIMain, MainRuntime } from '@teambit/cli';\nimport { Component, ComponentID } from '@teambit/component';\nimport { EnvsAspect, EnvsMain } from '@teambit/envs';\nimport { BitId } from '@teambit/legacy-bit-id';\n\nimport ManyComponentsWriter from '@teambit/legacy/dist/consumer/component-ops/many-components-writer';\nimport { LoggerAspect, LoggerMain } from '@teambit/logger';\nimport { GeneratorAspect, GeneratorMain } from '@teambit/generator';\nimport { PubsubAspect, PubsubMain } from '@teambit/pubsub';\nimport UIAspect, { UiMain } from '@teambit/ui';\nimport { Workspace, WorkspaceAspect } from '@teambit/workspace';\nimport { CompilerAspect } from './compiler.aspect';\nimport { CompileCmd } from './compiler.cmd';\nimport { CompilerService } from './compiler.service';\nimport { CompilerTask } from './compiler.task';\nimport { DistArtifact } from './dist-artifact';\nimport { DistArtifactNotFound } from './exceptions';\nimport { CompilationInitiator, Compiler } from './types';\nimport { CompileOptions, WorkspaceCompiler } from './workspace-compiler';\nimport { compilerTemplate } from './templates/compiler';\n\nexport class CompilerMain {\n  constructor(\n    private pubsub: PubsubMain,\n    private workspaceCompiler: WorkspaceCompiler,\n    private envs: EnvsMain,\n    private builder: BuilderMain\n  ) {}\n\n  /**\n   * Run compilation on `bit new` and when new components are imported\n   */\n  compileOnWorkspace(\n    componentsIds: string[] | BitId[] | ComponentID[] = [], // when empty, it compiles all\n    options: CompileOptions = { initiator: CompilationInitiator.ComponentAdded }\n  ) {\n    return this.workspaceCompiler.compileComponents(componentsIds, options);\n  }\n  /**\n   * API to create a new compiler task, it facilitates the usage of multiple compilers.\n   * with this method you can create any number of compilers and add them to the buildPipeline.\n   */\n  createTask(name: string, compiler: Compiler): CompilerTask {\n    return new CompilerTask(CompilerAspect.id, name, compiler);\n  }\n\n  /**\n   * find the compiler configured on the workspace and ask for the dist path.\n   */\n  getDistPathBySrcPath(component: Component, srcPath: string): string | null {\n    const environment = this.envs.getEnv(component).env;\n    const compilerInstance = environment.getCompiler?.();\n    if (!compilerInstance) return null;\n    return compilerInstance.getDistPathBySrcPath(srcPath);\n  }\n\n  async getDistsFiles(component: Component): Promise<DistArtifact> {\n    const artifacts = await this.builder.getArtifactsVinylByExtension(component, CompilerAspect.id);\n    if (!artifacts.length) throw new DistArtifactNotFound(component.id);\n\n    return new DistArtifact(artifacts);\n  }\n\n  static runtime = MainRuntime;\n\n  static dependencies = [\n    CLIAspect,\n    WorkspaceAspect,\n    EnvsAspect,\n    LoggerAspect,\n    PubsubAspect,\n    AspectLoaderAspect,\n    BuilderAspect,\n    UIAspect,\n    GeneratorAspect,\n  ];\n\n  static async provider([cli, workspace, envs, loggerMain, pubsub, aspectLoader, builder, ui, generator]: [\n    CLIMain,\n    Workspace,\n    EnvsMain,\n    LoggerMain,\n    PubsubMain,\n    AspectLoaderMain,\n    BuilderMain,\n    UiMain,\n    GeneratorMain\n  ]) {\n    const logger = loggerMain.createLogger(CompilerAspect.id);\n    const workspaceCompiler = new WorkspaceCompiler(workspace, envs, pubsub, aspectLoader, ui, logger);\n    envs.registerService(new CompilerService());\n    const compilerMain = new CompilerMain(pubsub, workspaceCompiler, envs, builder);\n    cli.register(new CompileCmd(workspaceCompiler, logger, pubsub));\n    generator.registerComponentTemplate([compilerTemplate]);\n    ManyComponentsWriter.externalCompiler = compilerMain.compileOnWorkspace.bind(compilerMain);\n\n    return compilerMain;\n  }\n}\n\nCompilerAspect.addRuntime(CompilerMain);\n"]}