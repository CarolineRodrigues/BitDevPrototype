{"version":3,"sources":["compiler.cmd.ts"],"names":["CompileCmd","constructor","compile","logger","pubsub","report","components","compilerOptions","startTimestamp","process","hrtime","setStatusLine","sub","CompilerAspect","id","onComponentCompilationDone","bind","outputString","compileComponents","initiator","CompilationInitiator","CmdReport","compileTimeLength","chalk","underline","componentsStatus","verbose","getStatusLine","clearStatusLine","data","code","getExitCode","json","deleteDistDir","compileResults","CmdJson","failedComponents","filter","component","errors","length","getSummaryIcon","green","red","yellow","numberOfComponents","numberOfFailingComponents","numberOfSuccessfulComponents","icon","summaryLine","event","type","ComponentCompilationOnDoneEvent","TYPE","push"],"mappings":"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","sourcesContent":["import { Command, CommandOptions } from '@teambit/cli';\nimport { Logger } from '@teambit/logger';\nimport type { PubsubMain, BitBaseEvent } from '@teambit/pubsub';\nimport chalk from 'chalk';\nimport prettyTime from 'pretty-time';\nimport { Component } from '@teambit/component';\nimport { formatCompileResults } from './output-formatter';\nimport { CompileError, WorkspaceCompiler, CompileOptions } from './workspace-compiler';\nimport { CompilationInitiator } from './types';\n\n// IDs & events\nimport { CompilerAspect } from './compiler.aspect';\nimport { ComponentCompilationOnDoneEvent } from './events';\n\nexport type ComponentsStatus = {\n  buildResults: string[];\n  component: Component;\n  errors: CompileError[];\n};\n\nexport class CompileCmd implements Command {\n  componentsStatus: ComponentsStatus[] = [];\n  name = 'compile [component...]';\n  description = 'compile components in the development workspace';\n  alias = '';\n  group = 'development';\n  options = [\n    ['c', 'changed', 'compile only new and modified components'],\n    ['v', 'verbose', 'show more data, such as, dist paths'],\n    ['j', 'json', 'return the compile results in json format'],\n    ['d', 'delete-dist-dir', 'delete existing dist folder before writing new compiled files'],\n  ] as CommandOptions;\n\n  constructor(private compile: WorkspaceCompiler, private logger: Logger, private pubsub: PubsubMain) {}\n\n  async report([components = []]: [string[]], compilerOptions: CompileOptions) {\n    const startTimestamp = process.hrtime();\n    this.logger.setStatusLine('Compiling your components, hold tight.');\n    this.pubsub.sub(CompilerAspect.id, this.onComponentCompilationDone.bind(this));\n\n    let outputString = '';\n    await this.compile.compileComponents(components, {\n      ...compilerOptions,\n      initiator: CompilationInitiator.CmdReport,\n    });\n    const compileTimeLength = process.hrtime(startTimestamp);\n\n    outputString += '\\n';\n    outputString += `  ${chalk.underline('STATUS')}\\t${chalk.underline('COMPONENT ID')}\\n`;\n    outputString += formatCompileResults(this.componentsStatus, !!compilerOptions.verbose);\n    outputString += '\\n';\n\n    outputString += this.getStatusLine(this.componentsStatus, compileTimeLength);\n\n    this.logger.clearStatusLine();\n\n    return {\n      data: outputString,\n      code: this.getExitCode(this.componentsStatus),\n    };\n  }\n\n  async json([components]: [string[]], compilerOptions: CompileOptions) {\n    compilerOptions.deleteDistDir = true;\n    // @ts-ignore\n    const compileResults = await this.compile.compileComponents(components, {\n      ...compilerOptions,\n      initiator: CompilationInitiator.CmdJson,\n    });\n    return {\n      data: compileResults,\n      // @todo: fix the code once compile is ready.\n      code: 0,\n    };\n  }\n\n  private failedComponents(componentsStatus: ComponentsStatus[]): ComponentsStatus[] {\n    return componentsStatus.filter((component) => component.errors.length);\n  }\n\n  private getSummaryIcon(componentsStatus: ComponentsStatus[]) {\n    switch (this.failedComponents(componentsStatus).length) {\n      case 0:\n        return chalk.green('✔');\n      case componentsStatus.length:\n        return chalk.red('✗');\n      default:\n        return chalk.yellow('⍻');\n    }\n  }\n\n  private getExitCode(componentsStatus: ComponentsStatus[]) {\n    return this.failedComponents(componentsStatus).length ? 1 : 0;\n  }\n\n  private getStatusLine(componentsStatus: ComponentsStatus[], compileTimeLength) {\n    const numberOfComponents = componentsStatus.length;\n    const numberOfFailingComponents = this.failedComponents(componentsStatus).length;\n    const numberOfSuccessfulComponents = componentsStatus.filter((component) => !component.errors.length).length;\n\n    const icon = this.getSummaryIcon(componentsStatus);\n    const summaryLine = numberOfFailingComponents\n      ? `${icon} ${numberOfFailingComponents}/${numberOfComponents} components failed to compile.`\n      : `${icon} ${numberOfSuccessfulComponents}/${numberOfComponents} components compiled successfully.`;\n\n    return `${summaryLine}\\nFinished. (${prettyTime(compileTimeLength)})`;\n  }\n\n  private onComponentCompilationDone(event: BitBaseEvent<any>) {\n    if (event.type === ComponentCompilationOnDoneEvent.TYPE) {\n      this.componentsStatus.push(event.data);\n    }\n  }\n}\n"]}