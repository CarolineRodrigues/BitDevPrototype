{"version":3,"sources":["renaming.main.runtime.ts"],"names":["RenamingMain","constructor","workspace","newComponentHelper","deprecation","rename","sourceIdStr","targetIdStr","options","sourceId","resolveComponentId","isTagged","hasVersion","sourceComp","get","targetId","getNewComponentId","undefined","scope","config","getConfig","writeAndAddNewComp","deprecate","bitMap","renameNewComponent","write","getRenamingInfo","component","renameConfig","state","aspects","RenamingAspect","id","renamedFrom","ComponentID","fromObject","comp","fromExisting","getConfigFromExistingToNewComponent","toObject","provider","cli","componentMain","graphql","renaming","register","RenameCmd","registerShowFragments","RenamingFragment","CLIAspect","WorkspaceAspect","DeprecationAspect","NewComponentHelperAspect","ComponentAspect","GraphqlAspect","MainRuntime","addRuntime"],"mappings":"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","sourcesContent":["import { CLIAspect, CLIMain, MainRuntime } from '@teambit/cli';\nimport ComponentAspect, { Component, ComponentID, ComponentMain } from '@teambit/component';\nimport { DeprecationAspect, DeprecationMain } from '@teambit/deprecation';\nimport GraphqlAspect, { GraphqlMain } from '@teambit/graphql';\nimport NewComponentHelperAspect, { NewComponentHelperMain } from '@teambit/new-component-helper';\nimport WorkspaceAspect, { Workspace } from '@teambit/workspace';\nimport { RenameCmd, RenameOptions } from './rename.cmd';\nimport { RenamingAspect } from './renaming.aspect';\nimport { RenamingFragment } from './renaming.fragment';\nimport { renamingSchema } from './renaming.graphql';\n\nexport class RenamingMain {\n  constructor(\n    private workspace: Workspace,\n    private newComponentHelper: NewComponentHelperMain,\n    private deprecation: DeprecationMain\n  ) {}\n\n  async rename(sourceIdStr: string, targetIdStr: string, options: RenameOptions): Promise<RenameResult> {\n    const sourceId = await this.workspace.resolveComponentId(sourceIdStr);\n    const isTagged = sourceId.hasVersion();\n    const sourceComp = await this.workspace.get(sourceId);\n    const targetId = this.newComponentHelper.getNewComponentId(targetIdStr, undefined, options?.scope);\n    if (isTagged) {\n      const config = await this.getConfig(sourceComp);\n      await this.newComponentHelper.writeAndAddNewComp(sourceComp, targetId, options, config);\n      await this.deprecation.deprecate(sourceId, targetId);\n    } else {\n      this.workspace.bitMap.renameNewComponent(sourceId, targetId);\n      await this.workspace.bitMap.write();\n    }\n\n    return {\n      sourceId,\n      targetId,\n    };\n  }\n\n  getRenamingInfo(component: Component): RenamingInfo | null {\n    const renameConfig = component.state.aspects.get(RenamingAspect.id)?.config as RenamingInfo | undefined;\n    if (!renameConfig) return null;\n    return {\n      renamedFrom: ComponentID.fromObject(renameConfig.renamedFrom),\n    };\n  }\n\n  private async getConfig(comp: Component) {\n    const fromExisting = await this.newComponentHelper.getConfigFromExistingToNewComponent(comp);\n    return {\n      ...fromExisting,\n      [RenamingAspect.id]: {\n        renamedFrom: comp.id.toObject(),\n      },\n    };\n  }\n\n  static slots = [];\n  static dependencies = [\n    CLIAspect,\n    WorkspaceAspect,\n    DeprecationAspect,\n    NewComponentHelperAspect,\n    ComponentAspect,\n    GraphqlAspect,\n  ];\n  static runtime = MainRuntime;\n  static async provider([cli, workspace, deprecation, newComponentHelper, componentMain, graphql]: [\n    CLIMain,\n    Workspace,\n    DeprecationMain,\n    NewComponentHelperMain,\n    ComponentMain,\n    GraphqlMain\n  ]) {\n    const renaming = new RenamingMain(workspace, newComponentHelper, deprecation);\n    cli.register(new RenameCmd(renaming));\n    graphql.register(renamingSchema(renaming));\n    componentMain.registerShowFragments([new RenamingFragment(renaming)]);\n    return renaming;\n  }\n}\n\nRenamingAspect.addRuntime(RenamingMain);\n\nexport type RenameResult = { sourceId: ComponentID; targetId: ComponentID };\n\nexport type RenamingInfo = {\n  renamedFrom: ComponentID;\n};\n"]}