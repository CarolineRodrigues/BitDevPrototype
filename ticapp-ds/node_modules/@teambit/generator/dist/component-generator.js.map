{"version":3,"sources":["component-generator.ts"],"names":["ComponentGenerator","constructor","workspace","componentIds","options","template","envs","newComponentHelper","aspectId","generate","dirsToDeleteIfFailed","generateResults","componentId","componentPath","getNewComponentPath","path","fs","existsSync","join","BitError","hasName","fullName","push","generateOneComponent","err","deleteGeneratedComponents","bitMap","write","dirs","Promise","all","map","dir","absoluteDir","remove","code","name","namePascalCase","pascalCase","nameCamelCase","files","generateFiles","mainFile","find","file","isMain","writeComponentFiles","addResults","track","rootDir","relativePath","componentName","defaultScope","scope","component","get","hasEnvConfiguredOriginally","hasEnvConfigured","envBeforeConfigChanges","getEnv","config","templateEnv","EnvsAspect","id","env","Object","keys","length","undefined","configWithEnv","addEnvIfProvidedByFlag","setEntireConfig","getEnvData","envFromFlag","envFromTemplate","envId","setBy","envSetBy","userEnv","templateFiles","dataToPersist","DataToPersist","vinylFiles","templateFile","templateFileVinyl","Vinyl","base","contents","Buffer","from","content","AbstractVinyl","fromVinyl","results","v","addManyFiles","addBasePath","persistAllToFS"],"mappings":"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","sourcesContent":["import Vinyl from 'vinyl';\nimport fs from 'fs-extra';\nimport pMapSeries from 'p-map-series';\nimport path from 'path';\nimport { Workspace } from '@teambit/workspace';\nimport EnvsAspect, { EnvsMain } from '@teambit/envs';\nimport camelcase from 'camelcase';\nimport { BitError } from '@teambit/bit-error';\nimport { PathOsBasedRelative } from '@teambit/legacy/dist/utils/path';\nimport { AbstractVinyl } from '@teambit/legacy/dist/consumer/component/sources';\nimport DataToPersist from '@teambit/legacy/dist/consumer/component/sources/data-to-persist';\nimport { NewComponentHelperMain } from '@teambit/new-component-helper';\nimport { ComponentID } from '@teambit/component-id';\nimport { ComponentTemplate, ComponentFile, ComponentConfig } from './component-template';\nimport { CreateOptions } from './create.cmd';\n\nexport type GenerateResult = { id: ComponentID; dir: string; files: string[]; envId: string; envSetBy: string };\n\nexport class ComponentGenerator {\n  constructor(\n    private workspace: Workspace,\n    private componentIds: ComponentID[],\n    private options: CreateOptions,\n    private template: ComponentTemplate,\n    private envs: EnvsMain,\n    private newComponentHelper: NewComponentHelperMain,\n    private aspectId: string\n  ) {}\n\n  async generate(): Promise<GenerateResult[]> {\n    const dirsToDeleteIfFailed: string[] = [];\n    const generateResults = await pMapSeries(this.componentIds, async (componentId) => {\n      try {\n        const componentPath = this.newComponentHelper.getNewComponentPath(componentId, this.options.path);\n        if (fs.existsSync(path.join(this.workspace.path, componentPath))) {\n          throw new BitError(`unable to create a component at \"${componentPath}\", this path already exist`);\n        }\n        if (await this.workspace.hasName(componentId.fullName)) {\n          throw new BitError(\n            `unable to create a component \"${componentId.fullName}\", a component with the same name already exist`\n          );\n        }\n        dirsToDeleteIfFailed.push(componentPath);\n        return await this.generateOneComponent(componentId, componentPath);\n      } catch (err: any) {\n        await this.deleteGeneratedComponents(dirsToDeleteIfFailed);\n        throw err;\n      }\n    });\n\n    await this.workspace.bitMap.write();\n\n    return generateResults;\n  }\n\n  private async deleteGeneratedComponents(dirs: string[]) {\n    await Promise.all(\n      dirs.map(async (dir) => {\n        const absoluteDir = path.join(this.workspace.path, dir);\n        try {\n          await fs.remove(absoluteDir);\n        } catch (err: any) {\n          if (err.code !== 'ENOENT') {\n            // if not exist, it's fine\n            throw err;\n          }\n        }\n      })\n    );\n  }\n\n  private async generateOneComponent(componentId: ComponentID, componentPath: string): Promise<GenerateResult> {\n    const name = componentId.name;\n    const namePascalCase = camelcase(name, { pascalCase: true });\n    const nameCamelCase = camelcase(name);\n    const files = this.template.generateFiles({ name, namePascalCase, nameCamelCase, componentId });\n    const mainFile = files.find((file) => file.isMain);\n    await this.writeComponentFiles(componentPath, files);\n    const addResults = await this.workspace.track({\n      rootDir: componentPath,\n      mainFile: mainFile?.relativePath,\n      componentName: componentId.fullName,\n      defaultScope: this.options.scope,\n    });\n    const component = await this.workspace.get(componentId);\n    const hasEnvConfiguredOriginally = this.envs.hasEnvConfigured(component);\n    const envBeforeConfigChanges = this.envs.getEnv(component);\n\n    let config = this.template.config;\n    if (config && typeof config === 'function') {\n      config = config({ aspectId: this.aspectId });\n    }\n\n    const templateEnv = config?.[EnvsAspect.id]?.env;\n\n    if (config && templateEnv && hasEnvConfiguredOriginally) {\n      // remove the env we got from the template.\n      delete config[templateEnv];\n      delete config[EnvsAspect.id].env;\n      if (Object.keys(config[EnvsAspect.id]).length === 0) delete config[EnvsAspect.id];\n      if (Object.keys(config).length === 0) config = undefined;\n    }\n\n    const configWithEnv = this.addEnvIfProvidedByFlag(config);\n    if (configWithEnv) this.workspace.bitMap.setEntireConfig(component.id, configWithEnv);\n\n    const getEnvData = () => {\n      const envFromFlag = this.options.env; // env entered by the user when running `bit create --env`\n      const envFromTemplate = config?.[EnvsAspect.id]?.env;\n      if (envFromFlag) {\n        return {\n          envId: envFromFlag,\n          setBy: '--env flag',\n        };\n      }\n      if (envFromTemplate) {\n        return {\n          envId: envFromTemplate,\n          setBy: 'template',\n        };\n      }\n      return {\n        envId: envBeforeConfigChanges.id,\n        setBy: hasEnvConfiguredOriginally ? 'workspace variants' : '<default>',\n      };\n    };\n    const { envId, setBy } = getEnvData();\n    return {\n      id: componentId,\n      dir: componentPath,\n      files: addResults.files,\n      envId,\n      envSetBy: setBy,\n    };\n  }\n\n  private addEnvIfProvidedByFlag(config?: ComponentConfig): ComponentConfig | undefined {\n    const userEnv = this.options.env; // env entered by the user when running `bit create --env`\n    const templateEnv = config?.[EnvsAspect.id]?.env;\n    if (!userEnv || userEnv === templateEnv) {\n      return config;\n    }\n    config = config || {};\n    if (templateEnv) {\n      // the component template has an env and the user wants a different env.\n      delete config[templateEnv];\n    }\n    config[userEnv] = {};\n    config[EnvsAspect.id] = config[EnvsAspect.id] || {};\n    config[EnvsAspect.id].env = userEnv;\n    return config;\n  }\n\n  /**\n   * writes the generated template files to the default directory set in the workspace config\n   */\n  private async writeComponentFiles(\n    componentPath: string,\n    templateFiles: ComponentFile[]\n  ): Promise<PathOsBasedRelative[]> {\n    const dataToPersist = new DataToPersist();\n    const vinylFiles = templateFiles.map((templateFile) => {\n      const templateFileVinyl = new Vinyl({\n        base: componentPath,\n        path: path.join(componentPath, templateFile.relativePath),\n        contents: Buffer.from(templateFile.content),\n      });\n      return AbstractVinyl.fromVinyl(templateFileVinyl);\n    });\n    const results = vinylFiles.map((v) => v.path);\n    dataToPersist.addManyFiles(vinylFiles);\n    dataToPersist.addBasePath(this.workspace.path);\n    await dataToPersist.persistAllToFS();\n    return results;\n  }\n}\n"]}