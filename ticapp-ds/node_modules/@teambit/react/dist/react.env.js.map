{"version":3,"sources":["react.env.ts"],"names":["ReactEnvType","defaultTsConfig","require","buildTsConfig","eslintConfig","prettierConfig","ReactEnv","constructor","jestAspect","tsAspect","compiler","webpack","workspace","pkg","tester","config","eslint","prettier","getTsConfig","targetTsConfig","getBuildTsConfig","getTester","jestConfigPath","jestModulePath","resolve","createTester","getTsCompilerOptions","mode","tsconfig","pathToSource","__dirname","replace","compileJs","compileJsx","types","getTsCompiler","transformers","tsModule","ts","tsCompileOptions","createCompiler","getCompiler","getLinter","context","defaultTransformer","configMutator","addExtensionTypes","allTransformers","createLinter","pluginPath","getFormatter","createFormatter","getFileMap","components","local","reduce","index","component","state","filesystem","files","forEach","file","path","id","toString","homepage","fullName","ComponentUrl","toUrl","writeFileMap","fileMap","Math","random","slice","JSON","stringify","getDevEnvId","ReactAspect","getSchemaExtractor","createSchemaExtractor","getDevServer","baseConfig","envDevConfig","componentDevConfig","peers","getAllHostDependencies","peerAliasesTransformer","merged","merge","createDevServer","getBundler","createComponentsWebpackBundler","development","baseProdConfig","Boolean","externalizePeer","componentProdConfig","mergedTransformers","createWebpackBundler","createTemplateWebpackBundler","createBundler","envComponentPeers","Object","keys","getDependencies","peerDependencies","additionalHostDeps","getAdditionalHostDependencies","concat","getDocsTemplate","getMounter","getPreviewConfig","strategyName","splitComponentBundle","getPackageJsonProps","getNpmIgnore","CAPSULE_ARTIFACTS_DIR","dependencies","react","devDependencies","getBuildPipe","modifiers","tsModifier","getCompilerTask","module","task","tsCompiler","createTask","__getDescriptor","type"],"mappings":"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","sourcesContent":["import ts, { TsConfigSourceFile } from 'typescript';\nimport { tmpdir } from 'os';\nimport { Component } from '@teambit/component';\nimport { ComponentUrl } from '@teambit/component.modules.component-url';\nimport { BuildTask, CAPSULE_ARTIFACTS_DIR } from '@teambit/builder';\nimport { merge } from 'lodash';\nimport { Bundler, BundlerContext, DevServer, DevServerContext } from '@teambit/bundler';\nimport { CompilerMain } from '@teambit/compiler';\nimport {\n  BuilderEnv,\n  CompilerEnv,\n  DependenciesEnv,\n  DevEnv,\n  LinterEnv,\n  PackageEnv,\n  TesterEnv,\n  FormatterEnv,\n  PipeServiceModifier,\n  PipeServiceModifiersMap,\n} from '@teambit/envs';\nimport { JestMain } from '@teambit/jest';\nimport { PkgMain } from '@teambit/pkg';\nimport { Tester, TesterMain } from '@teambit/tester';\nimport { TsConfigTransformer, TypescriptMain } from '@teambit/typescript';\nimport type { TypeScriptCompilerOptions } from '@teambit/typescript';\nimport { WebpackConfigTransformer, WebpackMain } from '@teambit/webpack';\nimport { Workspace } from '@teambit/workspace';\nimport { ESLintMain, EslintConfigTransformer } from '@teambit/eslint';\nimport { PrettierConfigTransformer, PrettierMain } from '@teambit/prettier';\nimport { Linter, LinterContext } from '@teambit/linter';\nimport { Formatter, FormatterContext } from '@teambit/formatter';\nimport { pathNormalizeToLinux } from '@teambit/legacy/dist/utils';\nimport type { ComponentMeta } from '@teambit/react.ui.highlighter.component-metadata.bit-component-meta';\nimport { SchemaExtractor } from '@teambit/schema';\nimport { join, resolve } from 'path';\nimport { outputFileSync } from 'fs-extra';\n// Makes sure the @teambit/react.ui.docs-app is a dependency\n// TODO: remove this import once we can set policy from component to component with workspace version. Then set it via the component.json\n// eslint-disable-next-line @typescript-eslint/no-unused-vars\nimport { ReactMainConfig } from './react.main.runtime';\nimport { ReactAspect } from './react.aspect';\n\n// webpack configs for both components and envs\nimport basePreviewConfigFactory from './webpack/webpack.config.base';\nimport basePreviewProdConfigFactory from './webpack/webpack.config.base.prod';\n\n// webpack configs for envs only\n// import devPreviewConfigFactory from './webpack/webpack.config.preview.dev';\nimport envPreviewDevConfigFactory from './webpack/webpack.config.env.dev';\n\n// webpack configs for components only\nimport componentPreviewProdConfigFactory from './webpack/webpack.config.component.prod';\nimport componentPreviewDevConfigFactory from './webpack/webpack.config.component.dev';\nimport { generateAddAliasesFromPeersTransformer } from './webpack/transformers';\n\nexport const ReactEnvType = 'react';\nconst defaultTsConfig = require('./typescript/tsconfig.json');\nconst buildTsConfig = require('./typescript/tsconfig.build.json');\nconst eslintConfig = require('./eslint/eslintrc');\nconst prettierConfig = require('./prettier/prettier.config.js');\n\n// TODO: move to be taken from the key mode of compiler context\ntype CompilerMode = 'build' | 'dev';\n\ntype GetBuildPipeModifiers = PipeServiceModifiersMap & {\n  tsModifier?: PipeServiceModifier;\n};\n\n/**\n * a component environment built for [React](https://reactjs.org) .\n */\nexport class ReactEnv\n  implements TesterEnv, CompilerEnv, LinterEnv, DevEnv, BuilderEnv, DependenciesEnv, PackageEnv, FormatterEnv\n{\n  constructor(\n    /**\n     * jest extension\n     */\n    private jestAspect: JestMain,\n\n    /**\n     * typescript extension.\n     */\n    private tsAspect: TypescriptMain,\n\n    /**\n     * compiler extension.\n     */\n    private compiler: CompilerMain,\n\n    /**\n     * webpack extension.\n     */\n    private webpack: WebpackMain,\n\n    /**\n     * workspace extension.\n     */\n    private workspace: Workspace,\n\n    /**\n     * pkg extension.\n     */\n    private pkg: PkgMain,\n\n    /**\n     * tester extension\n     */\n    private tester: TesterMain,\n\n    private config: ReactMainConfig,\n\n    private eslint: ESLintMain,\n\n    private prettier: PrettierMain\n  ) {}\n\n  getTsConfig(targetTsConfig?: TsConfigSourceFile): TsConfigSourceFile {\n    return targetTsConfig ? merge({}, defaultTsConfig, targetTsConfig) : defaultTsConfig;\n  }\n\n  getBuildTsConfig(targetTsConfig?: TsConfigSourceFile): TsConfigSourceFile {\n    return targetTsConfig ? merge({}, buildTsConfig, targetTsConfig) : buildTsConfig;\n  }\n\n  /**\n   * returns a component tester.\n   */\n  getTester(jestConfigPath: string, jestModulePath?: string): Tester {\n    const config = jestConfigPath || require.resolve('./jest/jest.config');\n    return this.jestAspect.createTester(config, jestModulePath || require.resolve('jest'));\n  }\n\n  private getTsCompilerOptions(mode: CompilerMode = 'dev'): TypeScriptCompilerOptions {\n    const tsconfig = mode === 'dev' ? defaultTsConfig : buildTsConfig;\n    const pathToSource = pathNormalizeToLinux(__dirname).replace('/dist/', '/src/');\n    const compileJs = true;\n    const compileJsx = true;\n    return {\n      tsconfig,\n      // TODO: @david please remove this line and refactor to be something that makes sense.\n      types: [resolve(pathToSource, './typescript/style.d.ts'), resolve(pathToSource, './typescript/asset.d.ts')],\n      compileJs,\n      compileJsx,\n    };\n  }\n\n  private getTsCompiler(mode: CompilerMode = 'dev', transformers: TsConfigTransformer[] = [], tsModule = ts) {\n    const tsCompileOptions = this.getTsCompilerOptions(mode);\n    return this.tsAspect.createCompiler(tsCompileOptions, transformers, tsModule);\n  }\n\n  getCompiler(transformers: TsConfigTransformer[] = [], tsModule = ts) {\n    return this.getTsCompiler('dev', transformers, tsModule);\n  }\n\n  /**\n   * returns and configures the component linter.\n   */\n  getLinter(context: LinterContext, transformers: EslintConfigTransformer[] = []): Linter {\n    const defaultTransformer: EslintConfigTransformer = (configMutator) => {\n      configMutator.addExtensionTypes(['.md', '.mdx']);\n      return configMutator;\n    };\n\n    const allTransformers = [defaultTransformer, ...transformers];\n\n    return this.eslint.createLinter(\n      context,\n      {\n        config: eslintConfig,\n        // resolve all plugins from the react environment.\n        pluginPath: __dirname,\n      },\n      allTransformers\n    );\n  }\n\n  /**\n   * returns and configures the component formatter.\n   */\n  getFormatter(context: FormatterContext, transformers: PrettierConfigTransformer[] = []): Formatter {\n    return this.prettier.createFormatter(\n      context,\n      {\n        config: prettierConfig,\n      },\n      transformers\n    );\n  }\n\n  private getFileMap(components: Component[], local = false) {\n    return components.reduce<{ [key: string]: ComponentMeta }>((index, component: Component) => {\n      component.state.filesystem.files.forEach((file) => {\n        index[file.path] = {\n          id: component.id.toString(),\n          homepage: local ? `/${component.id.fullName}` : ComponentUrl.toUrl(component.id),\n        };\n      });\n\n      return index;\n    }, {});\n  }\n\n  private writeFileMap(components: Component[], local?: boolean) {\n    const fileMap = this.getFileMap(components, local);\n    const path = join(tmpdir(), `${Math.random().toString(36).slice(2, 11)}.json`);\n    outputFileSync(path, JSON.stringify(fileMap));\n    return path;\n  }\n\n  /**\n   * required for `bit start`\n   */\n  getDevEnvId(id?: string) {\n    if (typeof id !== 'string') return ReactAspect.id;\n    return id || ReactAspect.id;\n  }\n\n  /**\n   * get a schema generator instance configured with the correct tsconfig.\n   */\n  getSchemaExtractor(tsconfig: TsConfigSourceFile): SchemaExtractor {\n    return this.tsAspect.createSchemaExtractor(this.getTsConfig(tsconfig));\n  }\n\n  /**\n   * returns and configures the React component dev server.\n   * required for `bit start`\n   */\n  getDevServer(context: DevServerContext, transformers: WebpackConfigTransformer[] = []): DevServer {\n    const baseConfig = basePreviewConfigFactory(false);\n    const envDevConfig = envPreviewDevConfigFactory(context.id);\n    const componentDevConfig = componentPreviewDevConfigFactory(this.workspace.path, context.id);\n    const peers = this.getAllHostDependencies();\n    const peerAliasesTransformer = generateAddAliasesFromPeersTransformer(peers);\n\n    const defaultTransformer: WebpackConfigTransformer = (configMutator) => {\n      const merged = configMutator.merge([baseConfig, envDevConfig, componentDevConfig]);\n      return merged;\n    };\n\n    return this.webpack.createDevServer(context, [defaultTransformer, peerAliasesTransformer, ...transformers]);\n  }\n\n  async getBundler(context: BundlerContext, transformers: WebpackConfigTransformer[] = []): Promise<Bundler> {\n    return this.createComponentsWebpackBundler(context, transformers);\n  }\n\n  async createComponentsWebpackBundler(\n    context: BundlerContext,\n    transformers: WebpackConfigTransformer[] = []\n  ): Promise<Bundler> {\n    const peers = this.getAllHostDependencies();\n    const peerAliasesTransformer = generateAddAliasesFromPeersTransformer(peers);\n    const baseConfig = basePreviewConfigFactory(!context.development);\n    const baseProdConfig = basePreviewProdConfigFactory(Boolean(context.externalizePeer), peers, context.development);\n    const componentProdConfig = componentPreviewProdConfigFactory();\n\n    const defaultTransformer: WebpackConfigTransformer = (configMutator) => {\n      const merged = configMutator.merge([baseConfig, baseProdConfig, componentProdConfig]);\n      return merged;\n    };\n    const mergedTransformers = [defaultTransformer, peerAliasesTransformer, ...transformers];\n    return this.createWebpackBundler(context, mergedTransformers);\n  }\n\n  async createTemplateWebpackBundler(\n    context: BundlerContext,\n    transformers: WebpackConfigTransformer[] = []\n  ): Promise<Bundler> {\n    const peers = this.getAllHostDependencies();\n    const peerAliasesTransformer = generateAddAliasesFromPeersTransformer(peers);\n    const baseConfig = basePreviewConfigFactory(!context.development);\n    const baseProdConfig = basePreviewProdConfigFactory(Boolean(context.externalizePeer), peers, context.development);\n\n    const defaultTransformer: WebpackConfigTransformer = (configMutator) => {\n      const merged = configMutator.merge([baseConfig, baseProdConfig]);\n      return merged;\n    };\n    const mergedTransformers = [defaultTransformer, peerAliasesTransformer, ...transformers];\n    return this.createWebpackBundler(context, mergedTransformers);\n  }\n\n  private async createWebpackBundler(\n    context: BundlerContext,\n    transformers: WebpackConfigTransformer[] = []\n  ): Promise<Bundler> {\n    return this.webpack.createBundler(context, transformers);\n  }\n\n  /**\n   * Get the peers configured by the env on the components + the host deps configured by the env\n   */\n  getAllHostDependencies() {\n    const envComponentPeers = Object.keys(this.getDependencies().peerDependencies || {}) || [];\n    const additionalHostDeps = this.getAdditionalHostDependencies() || [];\n    const peers = envComponentPeers.concat(additionalHostDeps);\n    return peers;\n  }\n\n  getAdditionalHostDependencies(): string[] {\n    return ['@teambit/mdx.ui.mdx-scope-context', '@mdx-js/react'];\n  }\n\n  /**\n   * returns a path to a docs template.\n   */\n  getDocsTemplate() {\n    return require.resolve('@teambit/react.ui.docs-app');\n  }\n\n  icon = 'https://static.bit.dev/extensions-icons/react.svg';\n\n  /**\n   * returns a paths to a function which mounts a given component to DOM\n   */\n  getMounter() {\n    return require.resolve('./mount');\n  }\n\n  getPreviewConfig() {\n    return {\n      strategyName: 'component',\n      splitComponentBundle: true,\n    };\n  }\n\n  /**\n   * define the package json properties to add to each component.\n   */\n  getPackageJsonProps() {\n    return this.tsAspect.getPackageJsonProps();\n  }\n\n  getNpmIgnore() {\n    // ignores only .ts files in the root directory, so d.ts files inside dists are unaffected.\n    // without this change, the package has \"index.ts\" file in the root, causing typescript to parse it instead of the\n    // d.ts files. (changing the \"types\" prop in the package.json file doesn't help).\n    return [`${CAPSULE_ARTIFACTS_DIR}/`];\n  }\n\n  /**\n   * adds dependencies to all configured components.\n   */\n  getDependencies() {\n    return {\n      dependencies: {\n        react: '-',\n        'react-dom': '-',\n        'core-js': '^3.0.0',\n      },\n      // TODO: add this only if using ts\n      devDependencies: {\n        react: '-',\n        'react-dom': '-',\n        '@types/mocha': '-',\n        '@types/node': '12.20.4',\n        '@types/react': '^17.0.8',\n        '@types/react-dom': '^17.0.5',\n        '@types/jest': '^26.0.0',\n        // This is added as dev dep since our jest file transformer uses babel plugins that require this to be installed\n        '@babel/runtime': '7.12.18',\n        '@types/testing-library__jest-dom': '5.9.5',\n      },\n      peerDependencies: {\n        react: '^16.8.0 || ^17.0.0',\n        'react-dom': '^16.8.0 || ^17.0.0',\n      },\n    };\n  }\n\n  /**\n   * returns the component build pipeline.\n   */\n  getBuildPipe(modifiers: GetBuildPipeModifiers = {}): BuildTask[] {\n    const transformers: TsConfigTransformer[] =\n      (modifiers?.tsModifier?.transformers as any as TsConfigTransformer[]) || [];\n    return [this.getCompilerTask(transformers, modifiers?.tsModifier?.module || ts), this.tester.task];\n  }\n\n  private getCompilerTask(transformers: TsConfigTransformer[] = [], tsModule = ts) {\n    const tsCompiler = this.getTsCompiler('build', transformers, tsModule);\n    return this.compiler.createTask('TSCompiler', tsCompiler);\n  }\n\n  async __getDescriptor() {\n    return {\n      type: ReactEnvType,\n    };\n  }\n}\n"]}