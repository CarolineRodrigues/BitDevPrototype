{"version":3,"sources":["cli.main.runtime.ts"],"names":["CLIMain","constructor","commandsSlot","onStartSlot","community","groups","register","commands","forEach","command","setDefaults","cmd","unregister","commandName","toArray","aspectId","filteredCommands","filter","name","map","set","values","flat","getCommand","find","registerGroup","description","AlreadyExistsError","registerOnStart","onStartFn","run","hasWorkspace","invokeOnStart","CliParser","CLIParser","undefined","getDocsDomain","parse","onStartFns","promises","onStart","Promise","all","alias","shortDescription","group","options","private","loader","internal","provider","config","cliMain","legacyExtensions","extension","registerHookActionsOnHooksManager","extensionsCommands","reduce","acc","curr","length","concat","legacyRegistry","legacyCommands","legacyCommandsAdapters","LegacyCommandAdapter","cliGenerateCmd","CliGenerateCmd","cliCmd","CliCmd","helpCmd","HelpCmd","push","CompletionCmd","CommunityAspect","MainRuntime","Slot","withType","CLIAspect","addRuntime"],"mappings":"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","sourcesContent":["import { Slot, SlotRegistry } from '@teambit/harmony';\nimport { buildRegistry } from '@teambit/legacy/dist/cli';\nimport { Command } from '@teambit/legacy/dist/cli/command';\nimport LegacyLoadExtensions from '@teambit/legacy/dist/legacy-extensions/extensions-loader';\nimport { CommunityAspect } from '@teambit/community';\nimport type { CommunityMain } from '@teambit/community';\n\nimport { groups, GroupsType } from '@teambit/legacy/dist/cli/command-groups';\nimport { clone } from 'lodash';\nimport { CLIAspect, MainRuntime } from './cli.aspect';\nimport { AlreadyExistsError } from './exceptions/already-exists';\nimport { getCommandId } from './get-command-id';\nimport { LegacyCommandAdapter } from './legacy-command-adapter';\nimport { CLIParser } from './cli-parser';\nimport { CompletionCmd } from './completion.cmd';\nimport { CliCmd, CliGenerateCmd } from './cli.cmd';\nimport { HelpCmd } from './help.cmd';\n\nexport type CommandList = Array<Command>;\nexport type OnStart = (hasWorkspace: boolean) => Promise<void>;\n\nexport type OnStartSlot = SlotRegistry<OnStart>;\nexport type CommandsSlot = SlotRegistry<CommandList>;\n\nexport class CLIMain {\n  public groups: GroupsType = clone(groups); // if it's not cloned, it is cached across loadBit() instances\n\n  constructor(private commandsSlot: CommandsSlot, private onStartSlot: OnStartSlot, private community: CommunityMain) {}\n\n  /**\n   * registers a new command in to the CLI.\n   */\n  register(...commands: CommandList) {\n    commands.forEach((command) => {\n      this.setDefaults(command);\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      command.commands!.forEach((cmd) => this.setDefaults(cmd));\n    });\n    this.commandsSlot.register(commands);\n  }\n\n  /**\n   * helpful for having the same command name in different environments (legacy and Harmony)\n   */\n  unregister(commandName: string) {\n    this.commandsSlot.toArray().forEach(([aspectId, commands]) => {\n      const filteredCommands = commands.filter((command) => {\n        return getCommandId(command.name) !== commandName;\n      });\n      this.commandsSlot.map.set(aspectId, filteredCommands);\n    });\n  }\n\n  /**\n   * list of all registered commands. (legacy and new).\n   */\n  get commands(): CommandList {\n    return this.commandsSlot.values().flat();\n  }\n\n  /**\n   * get an instance of a registered command. (useful for aspects to modify and extend existing commands)\n   */\n  getCommand(name: string): Command | undefined {\n    return this.commands.find((command) => command.name === name);\n  }\n\n  /**\n   * when running `bit help`, commands are grouped by categories.\n   * this method helps registering a new group by providing its name and a description.\n   * the name is what needs to be assigned to the `group` property of the Command interface.\n   * the description is what shown in the `bit help` output.\n   */\n  registerGroup(name: string, description: string) {\n    if (this.groups[name]) {\n      throw new AlreadyExistsError('group', name);\n    }\n    this.groups[name] = description;\n  }\n\n  registerOnStart(onStartFn: OnStart) {\n    this.onStartSlot.register(onStartFn);\n    return this;\n  }\n\n  /**\n   * execute commands registered to this aspect.\n   */\n  async run(hasWorkspace: boolean) {\n    await this.invokeOnStart(hasWorkspace);\n    const CliParser = new CLIParser(this.commands, this.groups, undefined, this.community.getDocsDomain());\n    await CliParser.parse();\n  }\n\n  private async invokeOnStart(hasWorkspace: boolean) {\n    const onStartFns = this.onStartSlot.values();\n    const promises = onStartFns.map(async (onStart) => onStart(hasWorkspace));\n    return Promise.all(promises);\n  }\n\n  private setDefaults(command: Command) {\n    command.alias = command.alias || '';\n    command.description = command.description || '';\n    command.shortDescription = command.shortDescription || '';\n    command.group = command.group || 'ungrouped';\n    command.options = command.options || [];\n    command.private = command.private || false;\n    command.commands = command.commands || [];\n    if (command.loader === undefined) {\n      if (command.internal) {\n        command.loader = false;\n      } else {\n        command.loader = true;\n      }\n    }\n  }\n\n  static dependencies = [CommunityAspect];\n  static runtime = MainRuntime;\n  static slots = [Slot.withType<CommandList>(), Slot.withType<OnStart>()];\n\n  static async provider(\n    [community]: [CommunityMain],\n    config,\n    [commandsSlot, onStartSlot]: [CommandsSlot, OnStartSlot]\n  ) {\n    const cliMain = new CLIMain(commandsSlot, onStartSlot, community);\n    const legacyExtensions = await LegacyLoadExtensions();\n    // Make sure to register all the hooks actions in the global hooks manager\n    legacyExtensions.forEach((extension) => {\n      extension.registerHookActionsOnHooksManager();\n    });\n\n    const extensionsCommands = legacyExtensions.reduce((acc, curr) => {\n      if (curr.commands && curr.commands.length) {\n        // @ts-ignore AUTO-ADDED-AFTER-MIGRATION-PLEASE-FIX!\n        acc = acc.concat(curr.commands);\n      }\n      return acc;\n    }, []);\n\n    const legacyRegistry = buildRegistry(extensionsCommands);\n    const legacyCommands = legacyRegistry.commands.concat(legacyRegistry.extensionsCommands || []);\n    const legacyCommandsAdapters = legacyCommands.map((command) => new LegacyCommandAdapter(command, cliMain));\n    const cliGenerateCmd = new CliGenerateCmd(cliMain);\n    const cliCmd = new CliCmd(cliMain, community.getDocsDomain());\n    const helpCmd = new HelpCmd(cliMain, community.getDocsDomain());\n    cliCmd.commands.push(cliGenerateCmd);\n    cliMain.register(...legacyCommandsAdapters, new CompletionCmd(), cliCmd, helpCmd);\n    return cliMain;\n  }\n}\n\nCLIAspect.addRuntime(CLIMain);\n"]}