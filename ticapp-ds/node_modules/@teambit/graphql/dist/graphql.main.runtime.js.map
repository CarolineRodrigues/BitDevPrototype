{"version":3,"sources":["graphql.main.runtime.ts"],"names":["Verb","GraphqlMain","constructor","config","moduleSlot","context","logger","graphQLServerSlot","pubSubSlot","Map","pubsub","pubSubSlots","values","length","PubSub","createServer","options","graphiql","localSchema","createRootModule","schemaSlot","remoteSchemas","schemas","schema","concat","filter","x","app","use","origin","callback","credentials","request","res","params","customFormatErrorFn","err","error","Object","assign","ERR_CODE","originalError","errors","name","HTTP_CODE","code","rootValue","server","subscriptionsPort","subscriptionsPortRange","subscriptionServerPort","getPort","port","createSubscription","proxySubscription","registerServer","register","registerPubSub","toArray","Error","listen","serverPort","subServer","info","subscriptionsPath","range","from","to","Port","websocketServer","response","writeHead","end","debug","SubscriptionServer","execute","subscribe","onConnect","onWsConnect","path","proxServer","httpProxy","createProxyServer","on","req","socket","head","url","ws","target","host","modules","buildModules","GraphQLModule","imports","schemaSlots","map","extensionId","moduleDeps","getModuleDependencies","module","typeDefs","resolvers","schemaDirectives","session","verb","headers","READ","set","extension","extensions","get","deps","getDependencies","ids","dep","id","Array","entries","depId","includes","undefined","provider","loggerFactory","createLogger","GraphqlAspect","graphqlMain","Slot","withType","MainRuntime","LoggerAspect","addRuntime"],"mappings":"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","sourcesContent":["import { mergeSchemas } from 'graphql-tools';\nimport { GraphQLModule } from '@graphql-modules/core';\nimport { MainRuntime } from '@teambit/cli';\nimport { Harmony, Slot, SlotRegistry } from '@teambit/harmony';\nimport { Logger, LoggerAspect, LoggerMain } from '@teambit/logger';\nimport express, { Express } from 'express';\nimport { graphqlHTTP } from 'express-graphql';\nimport { Port } from '@teambit/toolbox.network.get-port';\nimport { execute, subscribe } from 'graphql';\nimport { PubSubEngine, PubSub } from 'graphql-subscriptions';\nimport { createServer, Server } from 'http';\nimport httpProxy from 'http-proxy';\nimport { SubscriptionServer } from 'subscriptions-transport-ws';\nimport cors from 'cors';\nimport { GraphQLServer } from './graphql-server';\nimport { createRemoteSchemas } from './create-remote-schemas';\nimport { GraphqlAspect } from './graphql.aspect';\nimport { Schema } from './schema';\n\nexport enum Verb {\n  WRITE = 'write',\n  READ = 'read',\n}\n\nexport type GraphQLConfig = {\n  port: number;\n  subscriptionsPortRange: number[];\n  subscriptionsPath: string;\n};\n\nexport type GraphQLServerSlot = SlotRegistry<GraphQLServer>;\n\nexport type SchemaSlot = SlotRegistry<Schema>;\n\nexport type PubSubSlot = SlotRegistry<PubSubEngine>;\n\nexport type GraphQLServerOptions = {\n  schemaSlot?: SchemaSlot;\n  app?: Express;\n  graphiql?: boolean;\n  remoteSchemas?: GraphQLServer[];\n  subscriptionsPortRange?: number[];\n  onWsConnect?: Function;\n};\n\nexport class GraphqlMain {\n  constructor(\n    /**\n     * extension config\n     */\n    readonly config: GraphQLConfig,\n\n    /**\n     * slot for registering graphql modules\n     */\n    private moduleSlot: SchemaSlot,\n\n    /**\n     * harmony context.\n     */\n    private context: Harmony,\n\n    /**\n     * logger extension.\n     */\n    readonly logger: Logger,\n\n    private graphQLServerSlot: GraphQLServerSlot,\n\n    /**\n     * graphql pubsub. allows to emit events to clients.\n     */\n    private pubSubSlot: PubSubSlot\n  ) {}\n\n  get pubsub(): PubSubEngine {\n    const pubSubSlots = this.pubSubSlot.values();\n    if (pubSubSlots.length) return pubSubSlots[0];\n    return new PubSub();\n  }\n\n  private modules = new Map<string, GraphQLModule>();\n\n  async createServer(options: GraphQLServerOptions) {\n    const { graphiql = true } = options;\n    const localSchema = this.createRootModule(options.schemaSlot);\n    const remoteSchemas = await createRemoteSchemas(options.remoteSchemas || this.graphQLServerSlot.values());\n    const schemas = [localSchema.schema].concat(remoteSchemas).filter((x) => x);\n    const schema = mergeSchemas({\n      schemas,\n    });\n\n    // TODO: @guy please consider to refactor to express extension.\n    const app = options.app || express();\n    app.use(\n      // @ts-ignore todo: it's not clear what's the issue.\n      cors({\n        origin(origin, callback) {\n          callback(null, true);\n        },\n        credentials: true,\n      })\n    );\n\n    app.use(\n      '/graphql',\n      // eslint-disable-next-line @typescript-eslint/no-misused-promises\n      graphqlHTTP((request, res, params) => ({\n        customFormatErrorFn: (err) => {\n          this.logger.error('graphql got an error during running the following query:', params);\n          this.logger.error('graphql error ', err);\n          return Object.assign(err, {\n            // @ts-ignore\n            ERR_CODE: err?.originalError?.errors?.[0].ERR_CODE || err.originalError?.constructor?.name,\n            // @ts-ignore\n            HTTP_CODE: err?.originalError?.errors?.[0].HTTP_CODE || err.originalError?.code,\n          });\n        },\n        schema,\n        rootValue: request,\n        graphiql,\n      }))\n    );\n\n    const server = createServer(app);\n    const subscriptionsPort = options.subscriptionsPortRange || this.config.subscriptionsPortRange;\n    const subscriptionServerPort = await this.getPort(subscriptionsPort);\n    const { port } = await this.createSubscription(options, subscriptionServerPort);\n    this.proxySubscription(server, port);\n\n    return server;\n  }\n\n  /**\n   * register a new graphql server.\n   */\n  registerServer(server: GraphQLServer) {\n    this.graphQLServerSlot.register(server);\n    return this;\n  }\n\n  /**\n   * register a pubsub client\n   */\n  registerPubSub(pubsub: PubSubEngine) {\n    const pubSubSlots = this.pubSubSlot.toArray();\n    if (pubSubSlots.length) throw new Error('can not register more then one pubsub provider');\n    this.pubSubSlot.register(pubsub);\n    return this;\n  }\n\n  /**\n   * start a graphql server.\n   */\n  async listen(port?: number, server?: Server, app?: Express) {\n    const serverPort = port || this.config.port;\n    const subServer = server || (await this.createServer({ app }));\n\n    subServer.listen(serverPort, () => {\n      this.logger.info(`API Server over HTTP is now running on http://localhost:${serverPort}`);\n      this.logger.info(\n        `API Server over web socket with subscriptions is now running on ws://localhost:${serverPort}/${this.config.subscriptionsPath}`\n      );\n    });\n  }\n\n  /**\n   * register a new graphql module.\n   */\n  register(schema: Schema) {\n    // const module = new GraphQLModule(schema);\n    this.moduleSlot.register(schema);\n    return this;\n  }\n\n  private async getPort(range: number[]) {\n    const [from, to] = range;\n    return Port.getPort(from, to);\n  }\n\n  /** create Subscription server with different port */\n\n  private async createSubscription(options: GraphQLServerOptions, port: number) {\n    // Create WebSocket listener server\n    const websocketServer = createServer((request, response) => {\n      response.writeHead(404);\n      response.end();\n    });\n\n    // Bind it to port and start listening\n    websocketServer.listen(port, () =>\n      this.logger.debug(`Websocket Server is now running on http://localhost:${port}`)\n    );\n\n    const localSchema = this.createRootModule(options.schemaSlot);\n    const remoteSchemas = await createRemoteSchemas(options.remoteSchemas || this.graphQLServerSlot.values());\n    const schemas = [localSchema.schema].concat(remoteSchemas).filter((x) => x);\n    const schema = mergeSchemas({\n      schemas,\n    });\n\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    const subServer = new SubscriptionServer(\n      {\n        execute,\n        subscribe,\n        schema,\n        onConnect: options.onWsConnect,\n      },\n      {\n        server: websocketServer,\n        path: this.config.subscriptionsPath,\n      }\n    );\n    return { subServer, port };\n  }\n  /** proxy ws Subscription server to avoid conflict with different websocket connections */\n\n  private proxySubscription(server: Server, port: number) {\n    const proxServer = httpProxy.createProxyServer();\n    const subscriptionsPath = this.config.subscriptionsPath;\n    server.on('upgrade', function (req, socket, head) {\n      if (req.url === subscriptionsPath) {\n        proxServer.ws(req, socket, head, { target: { host: 'localhost', port } });\n      }\n    });\n  }\n\n  private createRootModule(schemaSlot?: SchemaSlot) {\n    const modules = this.buildModules(schemaSlot);\n\n    return new GraphQLModule({\n      imports: modules,\n    });\n  }\n\n  private buildModules(schemaSlot?: SchemaSlot) {\n    const schemaSlots = schemaSlot ? schemaSlot.toArray() : this.moduleSlot.toArray();\n    return schemaSlots.map(([extensionId, schema]) => {\n      const moduleDeps = this.getModuleDependencies(extensionId);\n\n      const module = new GraphQLModule({\n        typeDefs: schema.typeDefs,\n        resolvers: schema.resolvers,\n        schemaDirectives: schema.schemaDirectives,\n        imports: moduleDeps,\n        context: (session) => {\n          return {\n            ...session,\n            verb: session?.headers?.['x-verb'] || Verb.READ,\n          };\n        },\n      });\n\n      this.modules.set(extensionId, module);\n\n      return module;\n    });\n  }\n\n  private getModuleDependencies(extensionId: string): GraphQLModule[] {\n    const extension = this.context.extensions.get(extensionId);\n    if (!extension) throw new Error(`aspect ${extensionId} was not found`);\n    const deps = this.context.getDependencies(extension);\n    const ids = deps.map((dep) => dep.id);\n\n    // @ts-ignore check :TODO why types are breaking here.\n    return Array.from(this.modules.entries())\n      .map(([depId, module]) => {\n        const dep = ids.includes(depId);\n        if (!dep) return undefined;\n        return module;\n      })\n      .filter((module) => !!module);\n  }\n\n  static slots = [Slot.withType<Schema>(), Slot.withType<GraphQLServer>(), Slot.withType<PubSubSlot>()];\n\n  static defaultConfig = {\n    port: 4000,\n    subscriptionsPortRange: [2000, 2100],\n    subscriptionsPath: '/subscriptions',\n  };\n\n  static runtime = MainRuntime;\n  static dependencies = [LoggerAspect];\n\n  static async provider(\n    [loggerFactory]: [LoggerMain],\n    config: GraphQLConfig,\n    [moduleSlot, graphQLServerSlot, pubSubSlot]: [SchemaSlot, GraphQLServerSlot, PubSubSlot],\n    context: Harmony\n  ) {\n    const logger = loggerFactory.createLogger(GraphqlAspect.id);\n    const graphqlMain = new GraphqlMain(config, moduleSlot, context, logger, graphQLServerSlot, pubSubSlot);\n    return graphqlMain;\n  }\n}\n\nGraphqlAspect.addRuntime(GraphqlMain);\n"]}