{"version":3,"sources":["webpack.dev-server.ts"],"names":["WebpackDevServer","constructor","config","webpack","WsDevServer","WebpackAspect","id","getCompiler","displayConfig","depth","listen","port","devServer","Error","addSignalListener","addDevServerEntrypoints","webpackDs","start","server","process","on","exit"],"mappings":";;;;;;;;;;;;;;;;;;;;;AAIA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAMO,MAAMA,gBAAN,CAA4C;AACjDC,EAAAA,WAAW,CACDC,MADC,EAEDC,OAFC,EAGDC,WAHC,EAIT;AAAA,SAHQF,MAGR,GAHQA,MAGR;AAAA,SAFQC,OAER,GAFQA,OAER;AAAA,SADQC,WACR,GADQA,WACR;AAAA,gDAMGC,yBAAcC,EANjB;AAAA,yDAQY,oBARZ;AAAE;;AAEIC,EAAAA,WAAW,GAAQ;AACzB,WAAO,KAAKJ,OAAL,CAAa,KAAKD,MAAlB,CAAP;AACD;;AAMDM,EAAAA,aAAa,GAAW;AACtB,WAAO,qBAAQ,KAAKN,MAAb,EAAqB;AAAEO,MAAAA,KAAK,EAAE;AAAT,KAArB,CAAP;AACD;;AAEW,QAANC,MAAM,CAACC,IAAD,EAAgC;AAC1C,QAAI,CAAC,KAAKT,MAAL,CAAYU,SAAjB,EAA4B;AAC1B,YAAM,IAAIC,KAAJ,CAAU,6CAAV,CAAN;AACD,KAHyC,CAI1C;;;AACA,SAAKX,MAAL,CAAYU,SAAZ,CAAsBD,IAAtB,GAA6BA,IAA7B,CAL0C,CAO1C;;AACA,SAAKG,iBAAL,GAR0C,CAU1C;;AACA,QAAI,OAAQ,KAAKV,WAAN,CAA0BW,uBAAjC,KAA6D,WAAjE,EAA8E;AAC5E;AACA,YAAMC,SAAS,GAAG,IAAK,KAAKZ,WAAV,CAA8B,KAAKG,WAAL,EAA9B,EAAkD,KAAKL,MAAL,CAAYU,SAA9D,CAAlB;AACA,aAAOI,SAAS,CAACN,MAAV,CAAiBC,IAAjB,CAAP;AACD,KAfyC,CAiB1C;;;AACA,UAAMK,SAAc,GAAG,IAAI,KAAKZ,WAAT,CAAqB,KAAKF,MAAL,CAAYU,SAAjC,EAA4C,KAAKL,WAAL,EAA5C,CAAvB;AACA,UAAMS,SAAS,CAACC,KAAV,EAAN;AAEA,WAAOD,SAAS,CAACE,MAAjB;AACD;;AAEOJ,EAAAA,iBAAiB,GAAG;AAC1BK,IAAAA,OAAO,CAACC,EAAR,CAAW,SAAX,EAAsB,MAAM;AAC1BD,MAAAA,OAAO,CAACE,IAAR;AACD,KAFD;AAIAF,IAAAA,OAAO,CAACC,EAAR,CAAW,QAAX,EAAqB,MAAM;AACzBD,MAAAA,OAAO,CAACE,IAAR;AACD,KAFD;AAGD;;AAnDgD","sourcesContent":["import type { DevServer } from '@teambit/bundler';\nimport type { Server } from 'http';\nimport type { webpack as webpackCompiler, Configuration } from 'webpack';\nimport type * as WDS from 'webpack-dev-server';\nimport { inspect } from 'util';\nimport { WebpackAspect } from './webpack.aspect';\n\nexport interface WebpackConfigWithDevServer extends Configuration {\n  devServer: WDS.Configuration;\n  favicon?: string;\n}\nexport class WebpackDevServer implements DevServer {\n  constructor(\n    private config: WebpackConfigWithDevServer,\n    private webpack: typeof webpackCompiler,\n    private WsDevServer: WDS\n  ) {}\n\n  private getCompiler(): any {\n    return this.webpack(this.config);\n  }\n\n  id = WebpackAspect.id;\n\n  displayName = 'Webpack dev server';\n\n  displayConfig(): string {\n    return inspect(this.config, { depth: 10 });\n  }\n\n  async listen(port: number): Promise<Server> {\n    if (!this.config.devServer) {\n      throw new Error('Missing devServer configuration for webpack');\n    }\n    // Prevent different port between the config port and the listen arg port\n    this.config.devServer.port = port;\n\n    // Adding signal listeners to make sure we immediately close the process on sigint / sigterm (otherwise webpack dev server closing will take time)\n    this.addSignalListener();\n\n    // Compatibility check for Webpack dev server v3 (e.g. for Angular v8)\n    if (typeof (this.WsDevServer as any).addDevServerEntrypoints !== 'undefined') {\n      // @ts-ignore in the capsules it throws an error about compatibilities issues between webpack.compiler and webpackDevServer/webpack/compiler\n      const webpackDs = new (this.WsDevServer as any)(this.getCompiler(), this.config.devServer);\n      return webpackDs.listen(port);\n    }\n\n    // @ts-ignore in the capsules it throws an error about compatibilities issues between webpack.compiler and webpackDevServer/webpack/compiler\n    const webpackDs: WDS = new this.WsDevServer(this.config.devServer, this.getCompiler());\n    await webpackDs.start();\n\n    return webpackDs.server;\n  }\n\n  private addSignalListener() {\n    process.on('SIGTERM', () => {\n      process.exit();\n    });\n\n    process.on('SIGINT', () => {\n      process.exit();\n    });\n  }\n}\n"]}