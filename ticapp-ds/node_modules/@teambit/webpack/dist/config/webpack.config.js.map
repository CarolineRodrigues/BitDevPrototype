{"version":3,"sources":["webpack.config.ts"],"names":["configFactory","target","context","truthyEntries","Array","isArray","entries","length","filter","Boolean","dev","development","htmlConfig","html","compress","htmlPlugins","generateHtmlPlugins","undefined","shouldExternalizePeers","externalizePeer","peers","externals","getExternals","splitChunks","chunking","config","mode","bail","entry","infrastructureLogging","level","output","path","outputPath","sep","stats","errorDetails","resolve","alias","fallbacksAliases","fallback","fallbacks","plugins","webpack","ProvidePlugin","fallbacksProvidePluginConfig","getAssetManifestPlugin","filename","chunkFilename","runtimeChunkName","optimization","runtimeChunk","name","chunks","concat","CompressionPlugin","WebpackAssetsManifest","entrypoints","configs","map","generateHtmlPlugin","baseConfig","title","templateContent","minify","cache","chunksSortMode","favicon","filteredConfig","isUndefined","HtmlWebpackPlugin","deps","transformName","depName","replace","pascalCase"],"mappings":"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","sourcesContent":["/* eslint-disable complexity */\nimport camelcase from 'camelcase';\nimport webpack, { Configuration } from 'webpack';\nimport { generateExternals } from '@teambit/webpack.modules.generate-externals';\nimport { isUndefined, omitBy } from 'lodash';\nimport CompressionPlugin from 'compression-webpack-plugin';\nimport { sep } from 'path';\nimport type { BundlerContext, BundlerHtmlConfig, Target } from '@teambit/bundler';\nimport HtmlWebpackPlugin from 'html-webpack-plugin';\nimport WebpackAssetsManifest from 'webpack-assets-manifest';\nimport { fallbacks } from './webpack-fallbacks';\nimport { fallbacksProvidePluginConfig } from './webpack-fallbacks-provide-plugin-config';\nimport { fallbacksAliases } from './webpack-fallbacks-aliases';\n\nexport function configFactory(target: Target, context: BundlerContext): Configuration {\n  let truthyEntries =\n    Array.isArray(target.entries) && target.entries.length ? target.entries.filter(Boolean) : target.entries || {};\n  if (Array.isArray(truthyEntries) && !truthyEntries.length) {\n    truthyEntries = {};\n  }\n\n  const dev = Boolean(context.development);\n  const htmlConfig = target.html ?? context.html;\n  const compress = target.compress ?? context.compress;\n  const htmlPlugins = htmlConfig ? generateHtmlPlugins(htmlConfig) : undefined;\n  const shouldExternalizePeers =\n    (target.externalizePeer ?? context.externalizePeer) && target.peers && target.peers.length;\n  const externals = shouldExternalizePeers ? (getExternals(target.peers || []) as any) : undefined;\n  const splitChunks = target.chunking?.splitChunks;\n\n  const config: Configuration = {\n    mode: dev ? 'development' : 'production',\n    // Stop compilation early in production\n    bail: true,\n    // These are the \"entry points\" to our application.\n    // This means they will be the \"root\" imports that are included in JS bundle.\n    // @ts-ignore\n    entry: truthyEntries,\n\n    infrastructureLogging: {\n      level: 'error',\n    },\n\n    output: {\n      // The build folder.\n      path: `${target.outputPath}${sep}public`,\n    },\n    stats: {\n      errorDetails: true,\n    },\n\n    resolve: {\n      alias: fallbacksAliases,\n\n      fallback: fallbacks,\n    },\n\n    plugins: [new webpack.ProvidePlugin(fallbacksProvidePluginConfig), getAssetManifestPlugin()],\n  };\n\n  if (target.filename) {\n    config.output = config.output || {};\n    config.output.filename = target.filename;\n  }\n\n  if (target.chunkFilename) {\n    config.output = config.output || {};\n    config.output.chunkFilename = target.chunkFilename;\n  }\n\n  if (target.runtimeChunkName) {\n    config.optimization = config.optimization || {};\n    config.optimization.runtimeChunk = {\n      name: target.runtimeChunkName,\n    };\n  }\n\n  if (splitChunks) {\n    config.optimization = config.optimization || {};\n    config.optimization.splitChunks = {\n      chunks: 'all',\n      name: false,\n    };\n  }\n\n  if (htmlPlugins && htmlPlugins.length) {\n    if (!config.plugins) {\n      config.plugins = [];\n    }\n    config.plugins = config.plugins.concat(htmlPlugins);\n  }\n  if (compress) {\n    if (!config.plugins) {\n      config.plugins = [];\n    }\n    config.plugins = config.plugins.concat(new CompressionPlugin());\n  }\n  if (externals) {\n    config.externals = externals;\n  }\n  return config;\n}\n\nfunction getAssetManifestPlugin() {\n  return new WebpackAssetsManifest({ entrypoints: true });\n}\n\nfunction generateHtmlPlugins(configs: BundlerHtmlConfig[]) {\n  return configs.map((config) => generateHtmlPlugin(config));\n}\n\nfunction generateHtmlPlugin(config: BundlerHtmlConfig) {\n  const baseConfig = {\n    filename: config.filename,\n    chunks: config.chunks,\n    title: config.title,\n    templateContent: config.templateContent,\n    minify: config.minify,\n    cache: false,\n    chunksSortMode: 'auto' as const,\n    favicon: config.favicon,\n  };\n  if (baseConfig.chunks && baseConfig.chunks.length) {\n    // Make sure the order is that the preview root coming after the preview def\n    // we can't make it like this on the entries using depend on because this will\n    // prevent the splitting between different preview defs\n    // @ts-ignore\n    baseConfig.chunksSortMode = 'manual' as const;\n  }\n  const filteredConfig = omitBy(baseConfig, isUndefined);\n  return new HtmlWebpackPlugin(filteredConfig);\n}\n\nexport function getExternals(deps: string[]) {\n  return generateExternals(deps, {\n    transformName: (depName) => camelcase(depName.replace('@', '').replace('/', '-'), { pascalCase: true }),\n  });\n}\n"]}