{"version":3,"sources":["compositions.preview.runtime.ts"],"names":["CompositionsPreview","constructor","preview","render","componentId","modules","otherPreviewDefs","context","componentMap","fullName","compositions","selectPreviewModel","active","getActiveComposition","mainModule","default","previewModule","files","combined","Object","assign","module","chosen","window","location","hash","split","first","values","provider","compPreview","registerPreview","name","bind","PreviewRuntime","PreviewAspect","CompositionsAspect","addRuntime"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAQA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEO,MAAMA,mBAAN,CAA0B;AAC/BC,EAAAA,WAAW;AACT;AACJ;AACA;AACYC,EAAAA,OAJC,EAKT;AAAA,SADQA,OACR,GADQA,OACR;AAAE;;AAEJC,EAAAA,MAAM,CAACC,WAAD,EAA2BC,OAA3B,EAAmDC,gBAAnD,EAAqEC,OAArE,EAAgG;AACpG,QAAI,CAACF,OAAO,CAACG,YAAR,CAAqBJ,WAAW,CAACK,QAAjC,CAAL,EAAiD;AAEjD,UAAMC,YAAY,GAAG,KAAKC,kBAAL,CAAwBP,WAAW,CAACK,QAApC,EAA8CJ,OAA9C,CAArB;AACA,UAAMO,MAAM,GAAG,KAAKC,oBAAL,CAA0BH,YAA1B,CAAf;AAEAL,IAAAA,OAAO,CAACS,UAAR,CAAmBC,OAAnB,CAA2BH,MAA3B,EAAmCL,OAAnC;AACD;AAED;;;AACAI,EAAAA,kBAAkB,CAACP,WAAD,EAAsBY,aAAtB,EAAoD;AACpE,UAAMC,KAAK,GAAGD,aAAa,CAACR,YAAd,CAA2BJ,WAA3B,KAA2C,EAAzD,CADoE,CAGpE;;AACA,UAAMc,QAAQ,GAAGC,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkB,GAAGH,KAArB,CAAjB;AACA,WAAOC,QAAP;AACD;;AAEOL,EAAAA,oBAAoB,CAACQ,MAAD,EAAqB;AAC/C,UAAMC,MAAM,GAAGC,MAAM,CAACC,QAAP,CAAgBC,IAAhB,CAAqBC,KAArB,CAA2B,GAA3B,EAAgC,CAAhC,CAAf;;AAEA,QAAI,CAACJ,MAAL,EAAa;AACX,YAAMK,KAAK,GAAG,uBAAKR,MAAM,CAACS,MAAP,CAAcP,MAAd,CAAL,CAAd;AACA,aAAOM,KAAP;AACD;;AAED,WAAON,MAAM,CAACC,MAAD,CAAb;AACD;;AAMoB,eAARO,QAAQ,CAAC,CAAC3B,OAAD,CAAD,EAA8B;AACjD,UAAM4B,WAAW,GAAG,IAAI9B,mBAAJ,CAAwBE,OAAxB,CAApB;AACAA,IAAAA,OAAO,CAAC6B,eAAR,CAAwB;AACtBC,MAAAA,IAAI,EAAE,cADgB;AAEtB7B,MAAAA,MAAM,EAAE2B,WAAW,CAAC3B,MAAZ,CAAmB8B,IAAnB,CAAwBH,WAAxB,CAFc;AAGtBnB,MAAAA,kBAAkB,EAAEmB,WAAW,CAACnB,kBAAZ,CAA+BsB,IAA/B,CAAoCH,WAApC,CAHE;AAItBf,MAAAA,OAAO,EAAE;AAJa,KAAxB;AAOA,WAAOe,WAAP;AACD;;AAnD8B;;;gCAApB9B,mB,aAqCMkC,yB;gCArCNlC,mB,kBAuCW,CAACmC,wBAAD,C;;AAexBC,mCAAmBC,UAAnB,CAA8BrC,mBAA9B","sourcesContent":["import { ComponentID } from '@teambit/component-id';\nimport {\n  PreviewAspect,\n  PreviewPreview,\n  RenderingContext,\n  PreviewRuntime,\n  PreviewModule,\n  ModuleFile,\n} from '@teambit/preview';\nimport head from 'lodash.head';\n\nimport { CompositionsAspect } from './compositions.aspect';\n\nexport class CompositionsPreview {\n  constructor(\n    /**\n     * preview extension.\n     */\n    private preview: PreviewPreview\n  ) {}\n\n  render(componentId: ComponentID, modules: PreviewModule, otherPreviewDefs, context: RenderingContext) {\n    if (!modules.componentMap[componentId.fullName]) return;\n\n    const compositions = this.selectPreviewModel(componentId.fullName, modules);\n    const active = this.getActiveComposition(compositions);\n\n    modules.mainModule.default(active, context);\n  }\n\n  /** gets relevant information for this preview to render */\n  selectPreviewModel(componentId: string, previewModule: PreviewModule) {\n    const files = previewModule.componentMap[componentId] || [];\n\n    // allow compositions to come from many files. It is assumed they will have unique named\n    const combined = Object.assign({}, ...files);\n    return combined;\n  }\n\n  private getActiveComposition(module: ModuleFile) {\n    const chosen = window.location.hash.split('&')[1];\n\n    if (!chosen) {\n      const first = head(Object.values(module));\n      return first;\n    }\n\n    return module[chosen];\n  }\n\n  static runtime = PreviewRuntime;\n\n  static dependencies = [PreviewAspect];\n\n  static async provider([preview]: [PreviewPreview]) {\n    const compPreview = new CompositionsPreview(preview);\n    preview.registerPreview({\n      name: 'compositions',\n      render: compPreview.render.bind(compPreview),\n      selectPreviewModel: compPreview.selectPreviewModel.bind(compPreview),\n      default: true,\n    });\n\n    return compPreview;\n  }\n}\n\nCompositionsAspect.addRuntime(CompositionsPreview);\n"]}