{"version":3,"sources":["capsule.cmd.ts"],"names":["CapsuleCreateCmd","constructor","workspace","isolator","create","componentIds","baseDir","rootBaseDir","alwaysNew","id","installPackages","seedersOnly","Array","isArray","capsuleOptions","installOptions","includeFromNestedHosts","name","ids","resolveMultipleComponentIds","network","isolateComponents","capsules","graphCapsules","report","opts","capsuleOutput","map","capsule","chalk","bold","component","toString","path","join","title","length","green","json","c","CapsuleListCmd","list","workspaceCapsulesRootDir","scopeAspectsCapsulesRootDir","getCapsulesRootDirs","cyan","rootDirs","getCapsulesRootDir","scope","getAspectCapsulePath","CapsuleDeleteCmd","args","all","scopeAspects","capsuleBaseDirToDelete","capsuleBaseDir","deletedDir","deleteCapsules","CapsuleCmd"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;AAGA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;;;AAaO,MAAMA,gBAAN,CAA0C;AAoB/CC,EAAAA,WAAW,CAASC,SAAT,EAAuCC,QAAvC,EAA+D;AAAA,SAAtDD,SAAsD,GAAtDA,SAAsD;AAAA,SAAxBC,QAAwB,GAAxBA,QAAwB;AAAA,kDAnBnE,0BAmBmE;AAAA,yDAlB3D,iBAkB2D;AAAA,mDAjBlE,UAiBkE;AAAA,mDAhBlE,EAgBkE;AAAA,qDAfhE,CACR,CACE,GADF,EAEE,iBAFF,EAGE,yGAHF,CADQ,EAMR,CAAC,GAAD,EAAM,sBAAN,EAA8B,sEAA9B,CANQ,EAOR,CAAC,GAAD,EAAM,YAAN,EAAoB,oCAApB,CAPQ,EAQR,CAAC,GAAD,EAAM,cAAN,EAAsB,iEAAtB,CARQ,EASR,CAAC,GAAD,EAAM,WAAN,EAAmB,+BAAnB,CATQ,EAUR,CAAC,GAAD,EAAM,MAAN,EAAc,aAAd,CAVQ,EAWR,CAAC,GAAD,EAAM,kBAAN,EAA0B,yCAA1B,CAXQ,EAYR,CAAC,GAAD,EAAM,wBAAN,EAAgC,mCAAhC,CAZQ,CAegE;AAAE;;AAEhE,QAANC,MAAM,CACV,CAACC,YAAY,GAAG,EAAhB,CADU,EAEV;AAAEC,IAAAA,OAAF;AAAWC,IAAAA,WAAX;AAAwBC,IAAAA,SAAS,GAAG,KAApC;AAA2CC,IAAAA,EAA3C;AAA+CC,IAAAA,eAAe,GAAG,KAAjE;AAAwEC,IAAAA,WAAW,GAAG;AAAtF,GAFU,EAGY;AACtB;AACA,QAAIN,YAAY,IAAI,CAACO,KAAK,CAACC,OAAN,CAAcR,YAAd,CAArB,EAAkDA,YAAY,GAAG,CAACA,YAAD,CAAf;AAClD,UAAMS,cAAwC,GAAG;AAC/CR,MAAAA,OAD+C;AAE/CC,MAAAA,WAF+C;AAG/CQ,MAAAA,cAAc,EAAE;AAAEL,QAAAA;AAAF,OAH+B;AAI/CF,MAAAA,SAJ+C;AAK/CG,MAAAA,WAL+C;AAM/CK,MAAAA,sBAAsB,EAAE,IANuB;AAO/CC,MAAAA,IAAI,EAAER;AAPyC,KAAjD;AASA,UAAMS,GAAG,GAAG,MAAM,KAAKhB,SAAL,CAAeiB,2BAAf,CAA2Cd,YAA3C,CAAlB;AACA,UAAMe,OAAO,GAAG,MAAM,KAAKjB,QAAL,CAAckB,iBAAd,CAAgCH,GAAhC,EAAqCJ,cAArC,CAAtB;AACA,UAAMQ,QAAQ,GAAGF,OAAO,CAACG,aAAzB;AACA,WAAOD,QAAP;AACD;;AAEW,QAANE,MAAM,CAAC,CAACnB,YAAD,CAAD,EAA6BoB,IAA7B,EAA+C;AACzD;AACA,UAAMH,QAAQ,GAAG,MAAM,KAAKlB,MAAL,CAAYC,YAAZ,EAA0BoB,IAA1B,CAAvB;AACA,UAAMC,aAAa,GAAGJ,QAAQ,CAC3BK,GADmB,CACdC,OAAD,IAAc,GAAEC,iBAAMC,IAAN,CAAWF,OAAO,CAACG,SAAR,CAAkBtB,EAAlB,CAAqBuB,QAArB,EAAX,CAA4C,MAAKJ,OAAO,CAACK,IAAK,EAD/D,EAEnBC,IAFmB,CAEd,IAFc,CAAtB;AAGA,UAAMC,KAAK,GAAI,GAAEb,QAAQ,CAACc,MAAO,uCAAjC;AACA,WAAQ,GAAEP,iBAAMQ,KAAN,CAAYF,KAAZ,CAAmB,KAAIT,aAAc,EAA/C;AACD;;AAES,QAAJY,IAAI,CAAC,CAACjC,YAAD,CAAD,EAA6BoB,IAA7B,EAA+C;AACvD;AACA,UAAMH,QAAQ,GAAG,MAAM,KAAKlB,MAAL,CAAYC,YAAZ,EAA0BoB,IAA1B,CAAvB;AACA,WAAOH,QAAQ,CAACK,GAAT,CAAcY,CAAD,KAAQ;AAC1B9B,MAAAA,EAAE,EAAE8B,CAAC,CAACR,SAAF,CAAYtB,EAAZ,CAAeuB,QAAf,EADsB;AAE1BC,MAAAA,IAAI,EAAEM,CAAC,CAACN;AAFkB,KAAR,CAAb,CAAP;AAID;;AA5D8C;;;;AA+D1C,MAAMO,cAAN,CAAwC;AAQ7CvC,EAAAA,WAAW,CAASE,QAAT,EAAyCD,SAAzC,EAA+D;AAAA,SAAtDC,QAAsD,GAAtDA,QAAsD;AAAA,SAAtBD,SAAsB,GAAtBA,SAAsB;AAAA,kDAPnE,MAOmE;AAAA,yDAN3D,mBAM2D;AAAA,8DALvD,mBAKuD;AAAA,mDAJlE,UAIkE;AAAA,mDAHlE,EAGkE;AAAA,qDAFhE,CAAC,CAAC,GAAD,EAAM,MAAN,EAAc,aAAd,CAAD,CAEgE;AAAE;;AAEhE,QAANsB,MAAM,GAAG;AACb,UAAMiB,IAAI,GAAG,MAAM,KAAKtC,QAAL,CAAcsC,IAAd,CAAmB,KAAKvC,SAAL,CAAe+B,IAAlC,CAAnB;AACA,UAAM;AAAES,MAAAA,wBAAF;AAA4BC,MAAAA;AAA5B,QAA4D,KAAKC,mBAAL,EAAlE,CAFa,CAGb;;AACA,WAAOf,iBAAMQ,KAAN,CAAa,SAAQR,iBAAMgB,IAAN,CAAWJ,IAAI,CAACnB,QAAL,CAAcc,MAAd,CAAqBJ,QAArB,EAAX,CAA4C,+BAA8BH,iBAAMgB,IAAN,CACpGJ,IAAI,CAACvC,SAD+F,CAEpG;AACN,qCAAqC2B,iBAAMgB,IAAN,CAAWH,wBAAX,CAAqC;AAC1E,qCAAqCb,iBAAMgB,IAAN,CAAWF,2BAAX,CAAwC;AAC7E,qDALW,CAAP;AAMD;;AAES,QAAJL,IAAI,GAAG;AACX,UAAMG,IAAI,GAAG,MAAM,KAAKtC,QAAL,CAAcsC,IAAd,CAAmB,KAAKvC,SAAL,CAAe+B,IAAlC,CAAnB;AACA,UAAMa,QAAQ,GAAG,KAAKF,mBAAL,EAAjB;AACA,2CAAYH,IAAZ,GAAqBK,QAArB;AACD;;AAEOF,EAAAA,mBAAmB,GAAG;AAC5B,UAAMF,wBAAwB,GAAG,KAAKvC,QAAL,CAAc4C,kBAAd,CAAiC,KAAK7C,SAAL,CAAe+B,IAAhD,CAAjC;AACA,UAAMU,2BAA2B,GAAG,KAAKxC,QAAL,CAAc4C,kBAAd,CAAiC,KAAK7C,SAAL,CAAe8C,KAAf,CAAqBC,oBAArB,EAAjC,CAApC;AAEA,WAAO;AAAEP,MAAAA,wBAAF;AAA4BC,MAAAA;AAA5B,KAAP;AACD;;AAjC4C;;;;AAoCxC,MAAMO,gBAAN,CAA0C;AAW/CjD,EAAAA,WAAW,CAASE,QAAT,EAAyCD,SAAzC,EAA+D;AAAA,SAAtDC,QAAsD,GAAtDA,QAAsD;AAAA,SAAtBD,SAAsB,GAAtBA,SAAsB;AAAA,kDAVnE,QAUmE;AAAA,yDAT3D,sEAS2D;AAAA,8DARtD,iBAQsD;AAAA,mDAPlE,UAOkE;AAAA,mDANlE,EAMkE;AAAA,qDALhE,CACR,CAAC,EAAD,EAAK,eAAL,EAAsB,+BAAtB,CADQ,EAER,CAAC,GAAD,EAAM,KAAN,EAAa,mDAAb,CAFQ,CAKgE;AAAE;;AAEhE,QAANsB,MAAM,CAAC2B,IAAD,EAAW;AAAEC,IAAAA,GAAF;AAAOC,IAAAA;AAAP,GAAX,EAA2E;AACrF,UAAMC,sBAAsB,GAAG,MAAqB;AAClD,UAAIF,GAAJ,EAAS,OAAO,IAAP;AACT,UAAIC,YAAJ,EAAkB,OAAO,KAAKnD,SAAL,CAAe8C,KAAf,CAAqBC,oBAArB,EAAP;AAClB,aAAO,KAAK/C,SAAL,CAAe+B,IAAtB;AACD,KAJD;;AAKA,UAAMsB,cAAc,GAAGD,sBAAsB,EAA7C;AACA,UAAME,UAAU,GAAG,MAAM,KAAKrD,QAAL,CAAcsD,cAAd,CAA6BF,cAA7B,CAAzB;AACA,WAAO1B,iBAAMQ,KAAN,CAAa,+CAA8CR,iBAAMC,IAAN,CAAW0B,UAAX,CAAuB,EAAlF,CAAP;AACD;;AAtB8C;;;;AAyB1C,MAAME,UAAN,CAAoC;AAAA;AAAA,kDAClC,uBADkC;AAAA,8DAEtB,iBAFsB;AAAA,yDAG1B;AACjB;AACA;AACA;AACA,6CAP2C;AAAA,mDAQjC,EARiC;AAAA,mDASjC,UATiC;AAAA,sDAUnB,EAVmB;AAAA,qDAW/B,EAX+B;AAAA;;AAazC;AACY,QAANlC,MAAM,CAAC2B,IAAD,EAAiB;AAC3B;AACA,WAAQ,8BAAR;AACD;;AAjBwC","sourcesContent":["// eslint-disable-next-line max-classes-per-file\nimport { Command, CommandOptions } from '@teambit/cli';\nimport { CapsuleList, IsolateComponentsOptions, IsolatorMain } from '@teambit/isolator';\nimport chalk from 'chalk';\n\nimport { Workspace } from '.';\n\ntype CreateOpts = {\n  baseDir?: string;\n  rootBaseDir?: string;\n  alwaysNew?: boolean;\n  seedersOnly?: boolean;\n  id: string;\n  installPackages?: boolean;\n};\n\nexport class CapsuleCreateCmd implements Command {\n  name = 'create [componentIds...]';\n  description = `create capsules`;\n  group = 'capsules';\n  alias = '';\n  options = [\n    [\n      'b',\n      'base-dir <name>',\n      'set base dir of all capsules (hashed to create the base dir inside the root dir - host path by default)',\n    ],\n    ['r', 'root-base-dir <name>', 'set root base dir of all capsules (absolute path to use as root dir)'],\n    ['a', 'always-new', 'create new environment for capsule'],\n    ['s', 'seeders-only', 'create capsules for the seeders only (not for the entire graph)'],\n    ['i', 'id <name>', 'reuse capsule of certain name'],\n    ['j', 'json', 'json format'],\n    ['d', 'install-packages', 'install packages by the package-manager'],\n    ['p', 'package-manager <name>', 'npm, yarn or pnpm, default to npm'],\n  ] as CommandOptions;\n\n  constructor(private workspace: Workspace, private isolator: IsolatorMain) {}\n\n  async create(\n    [componentIds = []]: [string[]],\n    { baseDir, rootBaseDir, alwaysNew = false, id, installPackages = false, seedersOnly = false }: CreateOpts\n  ): Promise<CapsuleList> {\n    // @todo: why it is not an array?\n    if (componentIds && !Array.isArray(componentIds)) componentIds = [componentIds];\n    const capsuleOptions: IsolateComponentsOptions = {\n      baseDir,\n      rootBaseDir,\n      installOptions: { installPackages },\n      alwaysNew,\n      seedersOnly,\n      includeFromNestedHosts: true,\n      name: id,\n    };\n    const ids = await this.workspace.resolveMultipleComponentIds(componentIds);\n    const network = await this.isolator.isolateComponents(ids, capsuleOptions);\n    const capsules = network.graphCapsules;\n    return capsules;\n  }\n\n  async report([componentIds]: [string[]], opts: CreateOpts) {\n    // @ts-ignore\n    const capsules = await this.create(componentIds, opts);\n    const capsuleOutput = capsules\n      .map((capsule) => `${chalk.bold(capsule.component.id.toString())} - ${capsule.path}`)\n      .join('\\n');\n    const title = `${capsules.length} capsule(s) were created successfully`;\n    return `${chalk.green(title)}\\n${capsuleOutput}`;\n  }\n\n  async json([componentIds]: [string[]], opts: CreateOpts) {\n    // @ts-ignore\n    const capsules = await this.create(componentIds, opts);\n    return capsules.map((c) => ({\n      id: c.component.id.toString(),\n      path: c.path,\n    }));\n  }\n}\n\nexport class CapsuleListCmd implements Command {\n  name = 'list';\n  description = `list all capsules`;\n  shortDescription = 'list all capsules';\n  group = 'capsules';\n  alias = '';\n  options = [['j', 'json', 'json format']] as CommandOptions;\n\n  constructor(private isolator: IsolatorMain, private workspace: Workspace) {}\n\n  async report() {\n    const list = await this.isolator.list(this.workspace.path);\n    const { workspaceCapsulesRootDir, scopeAspectsCapsulesRootDir } = this.getCapsulesRootDirs();\n    // TODO: improve output\n    return chalk.green(`found ${chalk.cyan(list.capsules.length.toString())} capsule(s) for workspace:  ${chalk.cyan(\n      list.workspace\n    )}\nworkspace capsules root-dir:       ${chalk.cyan(workspaceCapsulesRootDir)}\nscope's aspects capsules root-dir: ${chalk.cyan(scopeAspectsCapsulesRootDir)}\nuse --json to get the list of all workspace capsules`);\n  }\n\n  async json() {\n    const list = await this.isolator.list(this.workspace.path);\n    const rootDirs = this.getCapsulesRootDirs();\n    return { ...list, ...rootDirs };\n  }\n\n  private getCapsulesRootDirs() {\n    const workspaceCapsulesRootDir = this.isolator.getCapsulesRootDir(this.workspace.path);\n    const scopeAspectsCapsulesRootDir = this.isolator.getCapsulesRootDir(this.workspace.scope.getAspectCapsulePath());\n\n    return { workspaceCapsulesRootDir, scopeAspectsCapsulesRootDir };\n  }\n}\n\nexport class CapsuleDeleteCmd implements Command {\n  name = 'delete';\n  description = `delete capsules. with no args, only workspace's capsules are deleted`;\n  shortDescription = `delete capsules`;\n  group = 'capsules';\n  alias = '';\n  options = [\n    ['', 'scope-aspects', 'delete scope-aspects capsules'],\n    ['a', 'all', 'delete all capsules for all workspaces and scopes'],\n  ] as CommandOptions;\n\n  constructor(private isolator: IsolatorMain, private workspace: Workspace) {}\n\n  async report(args: [], { all, scopeAspects }: { all: boolean; scopeAspects: boolean }) {\n    const capsuleBaseDirToDelete = (): string | null => {\n      if (all) return null;\n      if (scopeAspects) return this.workspace.scope.getAspectCapsulePath();\n      return this.workspace.path;\n    };\n    const capsuleBaseDir = capsuleBaseDirToDelete();\n    const deletedDir = await this.isolator.deleteCapsules(capsuleBaseDir);\n    return chalk.green(`the following capsules dir has been deleted ${chalk.bold(deletedDir)}`);\n  }\n}\n\nexport class CapsuleCmd implements Command {\n  name = 'capsule <sub-command>';\n  shortDescription = 'manage capsules';\n  description = `manage capsules.\na capsule is a directory contains the component code, isolated from the workspace.\nnormally, capsules are created during the build process, the component files are copied and the packages are installed\nvia the configured package-manager. the purpose is to compile/test them in isolation to make sure they will work for\nother users after publishing/exporting them.`;\n  alias = '';\n  group = 'capsules';\n  commands: Command[] = [];\n  options = [] as CommandOptions;\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  async report(args: [string]) {\n    // it should never be here. Yargs throws an error before reaching this method.\n    return `Please specify a sub-command`;\n  }\n}\n"]}