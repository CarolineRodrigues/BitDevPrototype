{"version":3,"sources":["component-config-file.ts"],"names":["DEFAULT_INDENT","DEFAULT_NEWLINE","ComponentConfigFile","constructor","componentId","aspects","componentDir","propagate","options","indent","newLine","defaultScope","load","aspectListFactory","outsideDefaultScope","filePath","composePath","isExist","fs","pathExists","undefined","content","readFile","parsed","parseComponentJsonContent","amount","ComponentID","fromObject","ExtensionDataList","fromConfigObject","extensions","Boolean","componentRootFolder","path","join","COMPONENT_CONFIG_FILE_NAME","write","json","toJson","override","AlreadyExistsError","writeJsonSync","spaces","EOL","addAspect","aspectId","config","resolveComponentId","existing","get","aspectEntry","aspectEntryFromConfigObject","entries","push","removeAspect","markWithMinusIfNotExist","aspectList","withoutEntries","REMOVE_EXTENSION_SPECIAL_SIGN","id","legacyEntry","AspectEntry","toObject","toConfigObject","toString","str","dir","JSON","parse","err","Error","message"],"mappings":"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","sourcesContent":["import { ComponentID, AspectList, AspectEntry, ResolveComponentIdFunc } from '@teambit/component';\nimport { COMPONENT_CONFIG_FILE_NAME } from '@teambit/legacy/dist/constants';\nimport { ExtensionDataList, configEntryToDataEntry } from '@teambit/legacy/dist/consumer/config/extension-data';\nimport { PathOsBasedAbsolute } from '@teambit/legacy/dist/utils/path';\nimport detectIndent from 'detect-indent';\nimport detectNewline from 'detect-newline';\nimport fs from 'fs-extra';\nimport path from 'path';\nimport stringifyPackage from 'stringify-package';\nimport { REMOVE_EXTENSION_SPECIAL_SIGN } from '@teambit/legacy/dist/consumer/config';\n\nimport { AlreadyExistsError } from './exceptions';\n\ninterface ComponentConfigFileOptions {\n  indent: number;\n  newLine: '\\r\\n' | '\\n' | undefined;\n}\n\ninterface WriteConfigFileOptions {\n  override?: boolean;\n}\n\ninterface ComponentConfigFileJson {\n  componentId: any;\n  // TODO: think if we want to change it to aspects\n  extensions: any;\n  propagate: boolean;\n  defaultScope?: string;\n}\n\nconst DEFAULT_INDENT = 2;\nconst DEFAULT_NEWLINE = '\\n';\n\nexport class ComponentConfigFile {\n  constructor(\n    public componentId: ComponentID,\n    public aspects: AspectList,\n    private componentDir: PathOsBasedAbsolute,\n    public propagate: boolean = false,\n    private options: ComponentConfigFileOptions = { indent: DEFAULT_INDENT, newLine: DEFAULT_NEWLINE },\n    public defaultScope?: string\n  ) {}\n\n  static async load(\n    componentDir: PathOsBasedAbsolute,\n    aspectListFactory: (extensionDataList: ExtensionDataList) => Promise<AspectList>,\n    outsideDefaultScope?: string\n  ): Promise<ComponentConfigFile | undefined> {\n    const filePath = ComponentConfigFile.composePath(componentDir);\n    const isExist = await fs.pathExists(filePath);\n    if (!isExist) {\n      return undefined;\n    }\n    const content = await fs.readFile(filePath, 'utf-8');\n    const parsed: ComponentConfigFileJson = parseComponentJsonContent(content, componentDir);\n    const indent = detectIndent(content).amount;\n    const newLine = detectNewline(content);\n    const componentId = ComponentID.fromObject(parsed.componentId, parsed.defaultScope || outsideDefaultScope);\n    const aspects = await aspectListFactory(ExtensionDataList.fromConfigObject(parsed.extensions));\n\n    return new ComponentConfigFile(\n      componentId,\n      aspects,\n      componentDir,\n      Boolean(parsed.propagate),\n      { indent, newLine },\n      parsed.defaultScope\n    );\n  }\n\n  static composePath(componentRootFolder: string) {\n    return path.join(componentRootFolder, COMPONENT_CONFIG_FILE_NAME);\n  }\n\n  async write(options: WriteConfigFileOptions = {}): Promise<void> {\n    const json = this.toJson();\n    const filePath = ComponentConfigFile.composePath(this.componentDir);\n    const isExist = await fs.pathExists(filePath);\n    if (isExist && !options.override) {\n      throw new AlreadyExistsError(filePath);\n    }\n    return fs.writeJsonSync(filePath, json, { spaces: this.options.indent, EOL: this.options.newLine });\n  }\n\n  async addAspect(aspectId: string, config: any, resolveComponentId: ResolveComponentIdFunc) {\n    const existing = this.aspects.get(aspectId);\n    if (existing) {\n      existing.config = config;\n    } else {\n      const aspectEntry = await this.aspectEntryFromConfigObject(aspectId, config, resolveComponentId);\n      this.aspects.entries.push(aspectEntry);\n    }\n  }\n\n  async removeAspect(aspectId: string, markWithMinusIfNotExist: boolean, resolveComponentId: ResolveComponentIdFunc) {\n    const existing = this.aspects.get(aspectId);\n    if (existing) {\n      const aspectList = this.aspects.withoutEntries([aspectId]);\n      this.aspects = aspectList;\n    } else if (markWithMinusIfNotExist) {\n      await this.addAspect(aspectId, REMOVE_EXTENSION_SPECIAL_SIGN, resolveComponentId);\n    }\n  }\n\n  private async aspectEntryFromConfigObject(id: string, config: any, resolveComponentId: ResolveComponentIdFunc) {\n    const aspectId = await resolveComponentId(id);\n    const legacyEntry = configEntryToDataEntry(id, config);\n    return new AspectEntry(aspectId, legacyEntry);\n  }\n\n  toJson(): ComponentConfigFileJson {\n    return {\n      componentId: this.componentId.toObject(),\n      propagate: this.propagate,\n      defaultScope: this.defaultScope,\n      extensions: this.aspects.toConfigObject(),\n    };\n  }\n\n  toString(): string {\n    const json = this.toJson();\n    return stringifyPackage(json, this.options.indent, this.options.newLine);\n  }\n}\n\nfunction parseComponentJsonContent(str: string, dir: string) {\n  try {\n    return JSON.parse(str);\n  } catch (err: any) {\n    throw new Error(`failed parsing component.json file at ${dir}. original error: ${err.message}`);\n  }\n}\n"]}