{"version":3,"sources":["scope-component-loader.ts"],"names":["ScopeComponentLoader","constructor","scope","logger","componentsCache","maxSize","importedComponentsCache","maxAge","get","id","importIfMissing","fromCache","getFromCache","idStr","toString","debug","legacyId","_legacy","modelComponent","legacyScope","getModelComponentIfExist","hasScope","import","BitIds","fromArray","set","changeScope","name","undefined","versionStr","version","latest","newId","changeVersion","loadVersion","objects","snap","createSnapFromVersion","state","createStateFromVersion","tagMap","getTagMap","component","Component","getFromConsumerComponent","consumerComponent","getModelComponent","resolveComponentId","pendingVersion","getRemoteComponent","compImport","ScopeComponentsImporter","objectList","getAll","forEach","obj","setCache","getConsumerComponent","getState","hash","load","Ref","getSnap","getVersionObject","err","code","errMsg","error","Error","clearCache","deleteAll","isEqual","TagMap","allVersions","versionsIncludeOrphaned","Object","keys","tag","Tag","SemVer","Snap","Date","parseInt","log","date","parents","map","p","displayName","username","email","message","State","Config","mainFile","extensions","componentExtension","createAspectListFromLegacy","ComponentFS","fromVinyls","files","dependencies"],"mappings":"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","sourcesContent":["import { Component, ComponentFS, ComponentID, Config, Snap, State, Tag, TagMap } from '@teambit/component';\nimport { Logger } from '@teambit/logger';\nimport { SemVer } from 'semver';\nimport ConsumerComponent from '@teambit/legacy/dist/consumer/component';\nimport ScopeComponentsImporter from '@teambit/legacy/dist/scope/component-ops/scope-components-importer';\nimport { ModelComponent, Version } from '@teambit/legacy/dist/scope/models';\nimport { BitIds } from '@teambit/legacy/dist/bit-id';\nimport { Ref } from '@teambit/legacy/dist/scope/objects';\nimport { getMaxSizeForComponents, InMemoryCache } from '@teambit/legacy/dist/cache/in-memory-cache';\nimport { createInMemoryCache } from '@teambit/legacy/dist/cache/cache-factory';\nimport type { ScopeMain } from './scope.main.runtime';\n\nexport class ScopeComponentLoader {\n  private componentsCache: InMemoryCache<Component>; // cache loaded components\n  private importedComponentsCache: InMemoryCache<boolean>;\n  constructor(private scope: ScopeMain, private logger: Logger) {\n    this.componentsCache = createInMemoryCache({ maxSize: getMaxSizeForComponents() });\n    this.importedComponentsCache = createInMemoryCache({ maxAge: 1000 * 60 * 30 }); // 30 min\n  }\n\n  async get(id: ComponentID, importIfMissing = true): Promise<Component | undefined> {\n    const fromCache = this.getFromCache(id);\n    if (fromCache) {\n      return fromCache;\n    }\n    const idStr = id.toString();\n    this.logger.debug(`ScopeComponentLoader.get, loading ${idStr}`);\n    const legacyId = id._legacy;\n    let modelComponent = await this.scope.legacyScope.getModelComponentIfExist(id._legacy);\n    // import if missing\n    if (\n      !modelComponent &&\n      importIfMissing &&\n      id._legacy.hasScope() &&\n      !this.importedComponentsCache.get(id.toString())\n    ) {\n      await this.scope.legacyScope.import(BitIds.fromArray([id._legacy]));\n      this.importedComponentsCache.set(id.toString(), true);\n      modelComponent = await this.scope.legacyScope.getModelComponentIfExist(id._legacy);\n    }\n    // Search with scope name for bare scopes\n    if (!modelComponent && !legacyId.scope) {\n      id = id.changeScope(this.scope.name);\n      modelComponent = await this.scope.legacyScope.getModelComponentIfExist(id._legacy);\n    }\n    if (!modelComponent) return undefined;\n\n    // :TODO move to head snap once we have it merged, for now using `latest`.\n    const versionStr = id.version && id.version !== 'latest' ? id.version : modelComponent.latest();\n    const newId = id.changeVersion(versionStr);\n    const version = await modelComponent.loadVersion(versionStr, this.scope.legacyScope.objects);\n    const snap = this.createSnapFromVersion(version);\n    const state = await this.createStateFromVersion(id, version);\n    const tagMap = this.getTagMap(modelComponent);\n\n    const component = new Component(newId, snap, state, tagMap, this.scope);\n    this.componentsCache.set(idStr, component);\n    return component;\n  }\n\n  async getFromConsumerComponent(consumerComponent: ConsumerComponent): Promise<Component> {\n    const legacyId = consumerComponent.id;\n    const modelComponent = await this.scope.legacyScope.getModelComponent(legacyId);\n    // :TODO move to head snap once we have it merged, for now using `latest`.\n    const id = await this.scope.resolveComponentId(legacyId);\n    const version =\n      consumerComponent.pendingVersion ||\n      (await modelComponent.loadVersion(legacyId.version as string, this.scope.legacyScope.objects));\n    const snap = this.createSnapFromVersion(version);\n    const state = await this.createStateFromVersion(id, version);\n    const tagMap = this.getTagMap(modelComponent);\n\n    return new Component(id, snap, state, tagMap, this.scope);\n  }\n\n  /**\n   * get a component from a remote without importing it\n   */\n  async getRemoteComponent(id: ComponentID): Promise<Component> {\n    const compImport = new ScopeComponentsImporter(this.scope.legacyScope);\n    const objectList = await compImport.getRemoteComponent(id._legacy);\n    // it's crucial to add all objects to the Repository cache. otherwise, later, when it asks\n    // for the consumerComponent from the legacyScope, it won't work.\n    objectList?.getAll().forEach((obj) => this.scope.legacyScope.objects.setCache(obj));\n    const consumerComponent = await this.scope.legacyScope.getConsumerComponent(id._legacy);\n    return this.getFromConsumerComponent(consumerComponent);\n  }\n\n  async getState(id: ComponentID, hash: string): Promise<State> {\n    const version = (await this.scope.legacyScope.objects.load(new Ref(hash))) as Version;\n    return this.createStateFromVersion(id, version);\n  }\n\n  async getSnap(id: ComponentID, hash: string): Promise<Snap> {\n    const getVersionObject = async (): Promise<Version> => {\n      try {\n        const snap = await this.scope.legacyScope.objects.load(new Ref(hash), true);\n        return snap as Version;\n      } catch (err: any) {\n        if (err.code === 'ENOENT') {\n          const errMsg = `fatal: snap \"${hash}\" file for component \"${id.toString()}\" was not found in the filesystem`;\n          this.logger.error(errMsg, err);\n          throw new Error(errMsg);\n        } else {\n          throw err;\n        }\n      }\n    };\n    const version = await getVersionObject();\n    return this.createSnapFromVersion(version);\n  }\n\n  clearCache() {\n    this.componentsCache.deleteAll();\n  }\n\n  /**\n   * make sure that not only the id-str match, but also the legacy-id.\n   * this is needed because the ComponentID.toString() is the same whether or not the legacy-id has\n   * scope-name, as it includes the defaultScope if the scope is empty.\n   * as a result, when out-of-sync is happening and the id is changed to include scope-name in the\n   * legacy-id, the component is the cache has the old id.\n   */\n  private getFromCache(id: ComponentID): Component | undefined {\n    const idStr = id.toString();\n    const fromCache = this.componentsCache.get(idStr);\n    if (fromCache && fromCache.id._legacy.isEqual(id._legacy)) {\n      return fromCache;\n    }\n    return undefined;\n  }\n\n  private getTagMap(modelComponent: ModelComponent): TagMap {\n    const tagMap = new TagMap();\n    const allVersions = modelComponent.versionsIncludeOrphaned;\n    Object.keys(allVersions).forEach((versionStr: string) => {\n      const tag = new Tag(allVersions[versionStr].toString(), new SemVer(versionStr));\n      tagMap.set(tag.version, tag);\n    });\n    return tagMap;\n  }\n\n  private createSnapFromVersion(version: Version): Snap {\n    return new Snap(\n      version.hash().toString(),\n      new Date(parseInt(version.log.date)),\n      version.parents.map((p) => p.toString()),\n      {\n        displayName: version.log.username || 'unknown',\n        email: version.log.email || 'unknown@anywhere',\n      },\n      version.log.message\n    );\n  }\n\n  private async createStateFromVersion(id: ComponentID, version: Version): Promise<State> {\n    const consumerComponent = await this.scope.legacyScope.getConsumerComponent(id._legacy);\n    const state = new State(\n      // We use here the consumerComponent.extensions instead of version.extensions\n      // because as part of the conversion to consumer component the artifacts are initialized as Artifact instances\n      new Config(version.mainFile, consumerComponent.extensions),\n      // todo: see the comment of this \"createAspectListFromLegacy\" method. the aspect ids may be incorrect.\n      // find a better way to get the ids correctly.\n      this.scope.componentExtension.createAspectListFromLegacy(consumerComponent.extensions, this.scope.name),\n      ComponentFS.fromVinyls(consumerComponent.files),\n      version.dependencies,\n      consumerComponent\n    );\n    return state;\n  }\n}\n"]}